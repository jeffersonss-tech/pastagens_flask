<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lotes - PastoFlow</title>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <link rel="icon" type="image/x-icon" href="/static/icon/PastoFlow-logo.ico">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/lotes.css') }}">
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div>
            <h1>ğŸ„ Lotes</h1>
            <p style="opacity: 0.8; font-size: 0.9rem;">{{ fazenda.nome }}</p>
        </div>
        <a href="/fazenda/{{ fazenda.id }}">â† Voltar</a>
    </div>
    
    <div class="content">
        <!-- Stats -->
        <div class="stats-row">
            <div class="stat-card animais">
                <strong id="stat-total">0</strong>
                <span>ğŸ„ Total de Lotes</span>
            </div>
            <div class="stat-card ocupacao">
                <strong id="stat-ocupacao">0</strong>
                <span>ğŸ“ Em OcupaÃ§Ã£o</span>
            </div>
            <div class="stat-card saida">
                <strong id="stat-saida">0</strong>
                <span>âš ï¸ Precisa Sair</span>
            </div>
            <div class="stat-card disponivel">
                <strong id="stat-animais">0</strong>
                <span>ğŸƒ Total Animais</span>
            </div>
        </div>
        
        <!-- Filters -->
        <div class="filters">
            <label>Status:</label>
            <select id="filtro-status" onchange="carregarLotes()">
                <option value="">Todos</option>
                <option value="OK">ğŸŸ¢ OK</option>
                <option value="ATENCAO">ğŸŸ  AtenÃ§Ã£o</option>
                <option value="RETIRAR">ğŸ”´ Retirar</option>
                <option value="AGUARDANDO_ALOCACAO">ğŸ”µ Aguardando AlocaÃ§Ã£o</option>
            </select>
            
            <label>Categoria:</label>
            <select id="filtro-categoria" onchange="carregarLotes()">
                <option value="">Todas</option>
                <option value="Bezerro(a)">Bezerro(a)</option>
                <option value="Garrote / Novilho(a)">Garrote / Novilho(a)</option>
                <option value="Boi Magro / Engorda">Boi Magro / Engorda</option>
                <option value="Vaca">Vaca</option>
                <option value="Touro">Touro</option>
            </select>
            
            <button class="btn btn-warning" onclick="atualizarStatus()">ğŸ”„ Atualizar Status</button>
            <button class="btn btn-primary" onclick="abrirModalNovoLote()">â• Novo Lote</button>
        </div>
        
        <!-- Tabela -->
        <div class="table-container">
            <div class="table-header">
                <h2>ğŸ“‹ Lotes Ativos</h2>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>ğŸ‚ Lote</th>
                        <th>ğŸ“ Piquete Atual</th>
                        <th>â±ï¸ Dias TÃ©cnicos</th>
                        <th>ğŸ“Š Status</th>
                        <th>ğŸ“‹ PrÃ³ximos</th>
                        <th>âš™ï¸ AÃ§Ãµes</th>
                    </tr>
                </thead>
                <tbody id="lista-lotes">
                    <tr>
                        <td colspan="6" class="empty-state">
                            <h3>Carregando...</h3>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- Modal ParÃ¢metros Personalizado -->
    <div class="modal" id="modal-personalizado" style="z-index: 2000;">
        <div class="modal-content" style="width: 400px; z-index: 2001;">
            <div class="modal-header">
                <h3>âš™ï¸ ParÃ¢metros TÃ©cnicos</h3>
                <button class="modal-close" onclick="fecharModal('modal-personalizado')">Ã—</button>
            </div>
            <div class="modal-body">
                <p style="color: #666; font-size: 0.9rem; margin-bottom: 15px;">
                    Informe os parÃ¢metros tÃ©cnicos para categoria <strong>Personalizado</strong>:
                </p>
                
                <div class="form-group">
                    <label>Peso MÃ©dio (kg) *</label>
                    <input type="number" id="param-peso-medio" placeholder="Ex: 350" step="0.1" min="50" max="1200">
                </div>
                
                <div class="form-group">
                    <label>Consumo Base (cm/dia em 2 UA/ha)</label>
                    <input type="number" id="param-consumo-base" value="0.8" step="0.05" min="0.1" max="3.0">
                    <small style="color: #666; font-size: 0.75rem;">Quanto o pasto Ã© consumido por animal por dia</small>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px;">
                    <button class="btn" style="background: #6c757d; color: white;" onclick="fecharModal('modal-personalizado')">Cancelar</button>
                    <button class="btn btn-success" onclick="confirmarPersonalizado()">Confirmar</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal Novo Lote -->
    {% include 'modals/lote_novo.html' %}
    
    <!-- Modal Editar Lote -->
    <div class="modal" id="modal-editar">
        <div class="modal-content" style="width: 450px;">
            <div class="modal-header">
                <h3>âœï¸ Editar Lote</h3>
                <button class="modal-close" onclick="fecharModal('modal-editar')">Ã—</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="edit-lote-id">
                
                <div class="form-group">
                    <label>Nome do Lote *</label>
                    <input type="text" id="edit-lote-nome" required>
                </div>
                
                <div class="form-group">
                    <label>Categoria</label>
                    <select id="edit-lote-categoria" onchange="verificarPersonalizadoEdit(); atualizarPesoMedioEdit();">
                        <option value="">Selecione...</option>
                        <option value="Bezerro(a)">Bezerro(a) - 200kg</option>
                        <option value="Garrote / Novilho(a)">Garrote / Novilho(a) - 325kg</option>
                        <option value="Boi Magro / Engorda">Boi Magro / Engorda - 475kg</option>
                        <option value="Vaca">Vaca - 500kg</option>
                        <option value="Touro">Touro - 850kg</option>
                        <option value="Personalizado">â­ Personalizado</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Quantidade de Animais</label>
                    <input type="number" id="edit-lote-quantidade" value="1" min="1">
                </div>
                
                <div class="form-group">
                    <label>Peso MÃ©dio (kg)</label>
                    <input type="number" id="edit-lote-peso" value="0" step="0.1">
                </div>
                
                <div class="form-group">
                    <label>Piquete Atual (opcional)</label>
                    <select id="edit-lote-piquete" onchange="verificarPiqueteRecuperacao()">
                        <option value="">Sem piquete</option>
                    </select>
                </div>
                
                <div id="aviso-piquete-recuperacao" style="display: none; background: #f8d7da; border: 2px solid #dc3545; border-radius: 8px; padding: 12px; margin-bottom: 15px; text-align: center;">
                    <strong style="color: #dc3545;">ğŸš¨ AVISO!</strong><br>
                    <small style="color: #721c24;">Este piquete estÃ¡ em RECUPERAÃ‡ÃƒO!</small><br>
                    <small style="color: #721c24;">Animais nÃ£o deveriam estar aqui. Considere outro piquete.</small>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 20px;">
                    <button class="btn btn-primary" onclick="salvarEdicaoLote()">ğŸ’¾ Salvar</button>
                    <button class="btn btn-warning" onclick="limparPiqueteEdicao()">ğŸš« Sem Piquete</button>
                    <button class="btn btn-danger" onclick="excluirLote()">ğŸ—‘ï¸ Excluir</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal Mover -->
    <div class="modal" id="modal-mover">
        <div class="modal-content">
            <div class="modal-header">
                <h3>â¡ï¸ Mover Lote</h3>
                <button class="modal-close" onclick="fecharModal('modal-mover')">Ã—</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="mover-lote-id">
                
                <div style="margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 8px;">
                    <strong>Lote:</strong> <span id="mover-lote-nome"></span>
                </div>
                
                <h4 style="margin-bottom: 15px;">Selecione o piquete de destino:</h4>
                <p style="color: #666; font-size: 0.85rem; margin-bottom: 15px;">
                    ğŸ’¡ Apenas piquetes APONTOS sÃ£o mostrados.
                </p>
                
                <div id="sugestoes-piquetes" style="margin-bottom: 15px;"></div>
                
                <div id="sem-piquetes-aptos" style="display: none; text-align: center; padding: 20px; color: #dc3545;">
                    âš ï¸ Nenhum piquete disponÃ­vel no momento!
                </div>
                
                <button class="btn btn-success" style="width: 100%; margin-top: 15px;" onclick="confirmarMovimentacao()">
                    âœ… Confirmar MovimentaÃ§Ã£o
                </button>
            </div>
        </div>
    </div>
    
    <!-- Modal Ver Todos os Piquetes -->
    <div class="modal" id="modal-todos-piquetes">
        <div class="modal-content" style="width: 500px;">
            <div class="modal-header">
                <h3>ğŸ“‹ Piquetes DisponÃ­veis</h3>
                <button class="modal-close" onclick="fecharModal('modal-todos-piquetes')">Ã—</button>
            </div>
            <div class="modal-body">
                <p style="color: #666; font-size: 0.85rem; margin-bottom: 15px;">
                    ğŸ’¡ Piquetes ordenados por prioridade (aptos primeiro)
                </p>
                <div id="lista-todos-piquetes" style="max-height: 400px; overflow-y: auto;"></div>
            </div>
        </div>
    </div>
    
    <!-- Modal Ver Detalhes do Lote -->
    <div class="modal" id="modal-detalhes">
        <div class="modal-content" style="width: 550px;">
            <div class="modal-header">
                <h3>ğŸ“‹ Detalhes do Lote</h3>
                <button class="modal-close" onclick="fecharModal('modal-detalhes')">Ã—</button>
            </div>
            <div class="modal-body" id="detalhes-lote-conteudo">
                <!-- ConteÃºdo preenchido via JavaScript -->
            </div>
        </div>
    </div>
    
    <script>
        const fazendaId = {{ fazenda.id }};
        let lotes = [];
        let dataTeste = null;  // Data de teste do backend (quando em modo teste)
        
        // Pesos mÃ©dios por categoria
        const pesosCategorias = {
            'Bezerro(a)': 200,
            'Garrote / Novilho(a)': 325,
            'Boi Magro / Engorda': 475,
            'Vaca': 500,
            'Touro': 850,
            'Personalizado': null
        };
        
        // FunÃ§Ã£o para calcular dias passados desde a entrada
        function calcularDiasPassados(dataEntrada) {
            if (!dataEntrada) return null;
            try {
                const entrada = new Date(dataEntrada);
                const agora = dataTeste || new Date();
                const diffTime = Math.abs(agora - entrada);
                const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                return diffDays;
            } catch (e) {
                console.error('Erro ao calcular dias:', e);
                return null;
            }
        }
        
        // FunÃ§Ã£o para formatar data para DD/MM/AAAA
        function formatarData(dataEntrada) {
            if (!dataEntrada) return null;
            try {
                const date = new Date(dataEntrada);
                const dia = String(date.getDate()).padStart(2, '0');
                const mes = String(date.getMonth() + 1).padStart(2, '0');
                const ano = date.getFullYear();
                return `${dia}/${mes}/${ano}`;
            } catch (e) {
                return null;
            }
        }
        
        // FunÃ§Ã£o para verificar se Ã© Personalizado e abrir modal
        let categoriaSelecionada = '';
        function verificarPersonalizado() {
            const select = document.getElementById('lote-categoria');
            if (select.value === 'Personalizado') {
                // Limpar o campo de peso e abrir modal de parÃ¢metros
                document.getElementById('lote-peso').value = '';
                document.getElementById('modal-personalizado').classList.add('active');
            } else {
                // Para categorias normais, auto-preencher o peso
                atualizarPesoMedio('lote');
            }
        }
        
        // FunÃ§Ã£o para verificar Personalizado na ediÃ§Ã£o
        function verificarPersonalizadoEdit() {
            const select = document.getElementById('edit-lote-categoria');
            if (select.value === 'Personalizado') {
                // Limpar o campo de peso e abrir modal de parÃ¢metros
                document.getElementById('edit-lote-peso').value = '';
                document.getElementById('modal-personalizado').classList.add('active');
                // Preencher com valores atuais se existirem
                const pesoEdit = document.getElementById('edit-lote-peso').value;
                if (pesoEdit && pesoEdit > 0) {
                    document.getElementById('param-peso-medio').value = pesoEdit;
                }
            } else {
                // Para categorias normais, auto-preencher o peso
                atualizarPesoMedio('edit');
            }
        }
        
        // FunÃ§Ã£o para confirmar Personalizado na ediÃ§Ã£o
        function confirmarPersonalizadoEdit() {
            const peso = parseFloat(document.getElementById('param-peso-medio').value) || 0;
            const consumo = parseFloat(document.getElementById('param-consumo-base').value) || 0.8;
            
            if (!peso || peso < 50 || peso > 1200) {
                alert('Peso mÃ©dio deve ser entre 50 e 1200 kg');
                return;
            }
            
            window.personalizadoParamsEdit = {
                peso_medio: peso,
                consumo_base: consumo
            };
            
            document.getElementById('edit-lote-peso').value = peso;
            fecharModal('modal-personalizado');
        }
        
        // Sobrescrever confirmarPersonalizado para ediÃ§Ã£o tambÃ©m
        function confirmarPersonalizado() {
            const peso = parseFloat(document.getElementById('param-peso-medio').value) || 0;
            const consumo = parseFloat(document.getElementById('param-consumo-base').value) || 0.8;
            
            if (!peso || peso < 50 || peso > 1200) {
                alert('Peso mÃ©dio deve ser entre 50 e 1200 kg');
                return;
            }
            if (consumo < 0.1 || consumo > 3.0) {
                alert('Consumo base deve ser entre 0.1 e 3.0 cm/dia');
                return;
            }
            
            window.personalizadoParams = {
                peso_medio: peso,
                consumo_base: consumo
            };
            
            document.getElementById('lote-peso').value = peso;
            fecharModal('modal-personalizado');
        }
        
        // FunÃ§Ã£o para atualizar peso mÃ©dio baseado na categoria (CRIAÃ‡ÃƒO)
        function atualizarPesoMedio() {
            const categoriaSelect = document.getElementById('lote-categoria');
            const pesoInput = document.getElementById('lote-peso');
            
            if (!categoriaSelect || !pesoInput) return;
            
            const categoria = categoriaSelect.value;
            if (categoria === 'Personalizado') return;
            
            const peso = pesosCategorias[categoria];
            if (peso !== undefined && peso !== null) {
                pesoInput.value = peso;
            }
        }
        
        // FunÃ§Ã£o para atualizar peso mÃ©dio (EDIÃ‡ÃƒO)
        function atualizarPesoMedioEdit() {
            const categoriaSelect = document.getElementById('edit-lote-categoria');
            const pesoInput = document.getElementById('edit-lote-peso');
            
            if (!categoriaSelect || !pesoInput) return;
            
            const categoria = categoriaSelect.value;
            if (categoria === 'Personalizado') return;
            
            const peso = pesosCategorias[categoria];
            if (peso !== undefined && peso !== null) {
                pesoInput.value = peso;
            }
        }
        
        // Carregar tudo ao iniciar
        window.onload = function() {
            // Primeiro carregar a data de teste, depois os lotes
            fetch('/api/data-teste')
                .then(r => r.json())
                .then(data => {
                    if (data.modo === 'teste' && data.data) {
                        dataTeste = new Date(data.data + 'T12:00:00');
                    }
                })
                .catch((err) => {
                    console.error('Erro ao buscar data-teste:', err);
                    dataTeste = null;
                })
                .finally(() => {
                    carregarLotesComDataTeste();
                    setInterval(() => carregarLotesComDataTeste(), 30000);
                    document.addEventListener('visibilitychange', () => {
                        if (!document.hidden) carregarLotesComDataTeste();
                    });
                });
        };
        
        function carregarLotesComDataTeste() {
            fetch('/api/data-teste')
                .then(r => r.json())
                .then(data => {
                    if (data.modo === 'teste' && data.data) {
                        dataTeste = new Date(data.data + 'T12:00:00');
                    } else {
                        dataTeste = null;
                    }
                })
                .catch(() => { dataTeste = null; })
                .finally(() => {
                    carregarLotes();
                    carregarPiquetesSelect();
                });
        }
        
        function carregarLotes() {
            const status = document.getElementById('filtro-status').value;
            const categoria = document.getElementById('filtro-categoria').value;
            
            fetch(`/api/lotes?fazenda_id=${fazendaId}&status=${status}&categoria=${categoria}`)
                .then(r => r.json())
                .then(data => {
                    lotes = data;
                    renderizarTabela();
                    atualizarStats();
                });
        }
        
        function atualizarStats() {
            document.getElementById('stat-total').textContent = lotes.length;
            const emOcupacao = lotes.filter(l => l.piquete_atual_id).length;
            document.getElementById('stat-ocupacao').textContent = emOcupacao;
            const precisaSair = lotes.filter(l => l.piquete_atual_id && (l.status_info?.status === 'RETIRAR')).length;
            document.getElementById('stat-saida').textContent = precisaSair;
            const totalAnimais = lotes.reduce((sum, l) => sum + (l.quantidade || 0), 0);
            document.getElementById('stat-animais').textContent = totalAnimais;
        }
        
        function renderizarTabela() {
            const tbody = document.getElementById('lista-lotes');
            if (lotes.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" class="empty-state"><h3>ğŸ˜• Nenhum lote encontrado</h3><p>Cadastre o primeiro lote ou ajuste os filtros.</p></td></tr>`;
                return;
            }
            Promise.all(lotes.map(l => fetch(`/api/lotes/${l.id}/sugerir-piquetes?fazenda_id=${fazendaId}`).then(r => r.json())))
            .then(sugestoesArrays => {
                const sugestoesMap = {};
                lotes.forEach((l, i) => sugestoesMap[l.id] = sugestoesArrays[i]);
                
                tbody.innerHTML = lotes.map((lote, idx) => {
                    const sugestoes = sugestoesMap[lote.id] || [];
                    const temPiquete = !!lote.piquete_atual_id;
                    const statusCalc = lote.status_info ? lote.status_info.status : (lote.status_calculado || '');
                    
                    let statusBadge = !temPiquete ? '<span class="status-badge aguardando">ğŸ”µ Aguardando AlocaÃ§Ã£o</span>' : 
                        (statusCalc === 'RETIRAR' ? '<span class="status-badge retirar">ğŸ”´ Retirar</span>' : 
                        (statusCalc === 'ATENCAO' ? '<span class="status-badge atencao">ğŸŸ  AtenÃ§Ã£o</span>' : 
                        '<span class="status-badge ocupacao">ğŸ”µ Em OcupaÃ§Ã£o</span>'));
                    
                    let diasHtml = !temPiquete ? '<span style="color: #999;">â€”</span>' : (function(){
                        const diasPassados = calcularDiasPassados(lote.data_entrada);
                        const dataFormatada = formatarData(lote.data_entrada);
                        const diasRestantes = Math.max(0, (lote.dias_tecnicos || 0) - diasPassados);
                        return `<div class="dias-info"><span class="atual">${lote.dias_tecnicos || 0}</span> dias tÃ©cnicos${dataFormatada ? `<br><small>ğŸ“… Entrada: ${dataFormatada}</small>` : ''}${diasPassados !== null ? `<br><small style="color: #007bff;">â±ï¸ ${diasPassados} dia(s)</small>` : ''}${diasRestantes > 0 ? `<br><small style="color: #28a745;">ğŸ“Š ${diasRestantes} dias restantes</small>` : ''}</div>`;
                    })();
                    
                    let piqueteInfo = temPiquete ? `${lote.piquete_nome}<br><small style="color: #28a745;">ğŸ“ ${lote.altura_estimada || '?'}cm</small>` : '<span style="color: #999;">Sem piquete</span>';
                    
                    let proximoHtml = sugestoes.length > 0 ? (function(){
                        const aptos = sugestoes.filter(p => p.status === 'APTO' || p.status === 'APTO_ALCANCADA').length;
                        const emRecup = sugestoes.filter(p => p.status === 'RECUPERANDO').length;
                        return `<button class="btn btn-sm" style="background: #6c757d; color: white;" onclick="abrirModalTodosPiquetes(${lote.id})">ğŸ“‹ Ver ${sugestoes.length} opÃ§Ãµes</button><br><small style="color: #28a745;">ğŸŸ¢ ${aptos} aptos</small>${emRecup > 0 ? `<br><small style="color: #856404;">ğŸŸ¡ ${emRecup} em recup.</small>` : ''}`;
                    })() : '<span style="font-size: 0.85rem; color: #999;">âš ï¸ Nenhum disponÃ­vel</span>';
                    
                    let actions = (function(){
                        const aptos = sugestoes.filter(p => p.status === 'APTO' || p.status === 'APTO_ALCANCADA');
                        const emRecuperando = sugestoes.filter(p => p.status === 'RECUPERANDO');
                        if (temPiquete) return `<button class="btn-mover" onclick="abrirModalMover(${lote.id}, '${lote.nome}')">â¡ï¸ Mover</button><button class="btn-sair" onclick="registrarSaida(${lote.id})">ğŸ“¤ Sair</button><button class="btn-edit" onclick="abrirModalEditar(${lote.id})">âœï¸ Edit</button>`;
                        if (aptos.length > 0) return `<button class="btn-mover" onclick="abrirModalMover(${lote.id}, '${lote.nome}')">â¡ï¸ Alocar</button><button class="btn-edit" onclick="abrirModalEditar(${lote.id})">âœï¸ Edit</button>`;
                        return `<button class="btn-edit" onclick="abrirModalEditar(${lote.id})">âœï¸ Edit</button>`;
                    })();
                    
                    return `<tr><td style="cursor: pointer;" onclick="abrirModalDetalhes(${lote.id})"><strong style="color: #007bff;">${lote.nome}</strong><br><small style="color: #666;">${lote.categoria || '-'} â€¢ ${lote.quantidade || 0} animai(s)</small></td><td>${piqueteInfo}</td><td>${diasHtml}</td><td>${statusBadge}</td><td>${proximoHtml}</td><td>${actions}</td></tr>`;
                }).join('');
            });
        }
        
        function carregarPiquetesSelect() {
            fetch('/api/piquetes/disponiveis?fazenda_id=' + fazendaId)
                .then(r => r.json())
                .then(data => {
                    const select = document.getElementById('lote-piquete');
                    select.innerHTML = '<option value="">Nenhum (lote sem piquete)</option>' +
                        data.map(p => {
                            const temReal = p.altura_real_medida !== null && p.altura_real_medida !== undefined;
                            const alturaUsada = temReal ? p.altura_real_medida : p.altura_estimada;
                            const emoji = p.bloqueado ? 'ğŸ”´' : (alturaUsada >= p.altura_entrada ? 'ğŸŸ¢' : 'ğŸŸ¡');
                            return `<option value="${p.id}">${p.nome} (${p.capim || 'N/I'}) ${emoji} ${p.bloqueado ? 'BLOQUEADO' : (alturaUsada >= p.altura_entrada ? 'APTO' : 'RECUPERANDO')} â€¢ ${p.dias_descanso || 0}/${p.dias_ideais || 30} dias</option>`;
                        }).join('');
                });
        }
        
        function abrirModalNovoLote() {
            window.personalizadoParams = null;
            document.getElementById('lote-nome').value = '';
            document.getElementById('lote-quantidade').value = '1';
            document.getElementById('lote-categoria').selectedIndex = 0;
            document.getElementById('lote-peso').value = 200;
            document.getElementById('modal-lote').classList.add('active');
            carregarPiquetesSelect();
        }
        
        function salvarLote() {
            const nome = document.getElementById('lote-nome').value;
            if (!nome) return alert('Digite o nome do lote!');
            const categoria = document.getElementById('lote-categoria').value;
            let peso_medio = parseFloat(document.getElementById('lote-peso').value) || 0;
            let payload = {
                nome, categoria,
                quantidade: parseInt(document.getElementById('lote-quantidade').value) || 1,
                peso_medio,
                piquete_id: document.getElementById('lote-piquete').value || null
            };
            if (categoria === 'Personalizado') {
                if (!window.personalizadoParams) return alert('Configure os parÃ¢metros tÃ©cnicos do Personalizado!');
                payload.peso_medio = window.personalizadoParams.peso_medio;
                payload.consumo_base = window.personalizadoParams.consumo_base;
            }
            fetch('/api/lotes', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            }).then(r => r.json()).then(data => {
                if (data.status === 'ok') { fecharModal('modal-lote'); carregarLotes(); alert('Lote criado com sucesso!'); }
            });
        }
        
        function abrirModalMover(loteId, nome) {
            document.getElementById('mover-lote-id').value = loteId;
            document.getElementById('mover-lote-nome').textContent = nome;
            document.getElementById('modal-mover').classList.add('active');
            fetch(`/api/lotes/${loteId}/sugerir-piquetes?fazenda_id=${fazendaId}`)
                .then(r => r.json()).then(data => {
                    const container = document.getElementById('sugestoes-piquetes');
                    const aptos = data.filter(p => p.status === 'APTO' || p.status === 'APTO_ALCANCADA');
                    if (aptos.length === 0) {
                        container.innerHTML = '';
                        document.getElementById('sem-piquetes-aptos').style.display = 'block';
                    } else {
                        document.getElementById('sem-piquetes-aptos').style.display = 'none';
                        container.innerHTML = aptos.map(p => `
                            <div class="sugestao-item apto" onclick="selecionarPiquete(${p.id}, this)">
                                <div class="sugestao-header"><span class="sugestao-nome">${p.nome}</span><span class="sugestao-badge badge-apto">ğŸŸ¢ APTO</span></div>
                                <div class="sugestao-info">${p.capim} â€¢ ${p.area} ha â€¢ ${p.dias_descanso} dias descanso</div>
                            </div>
                        `).join('');
                    }
                });
        }
        
        let piqueteSelecionado = null;
        function selecionarPiquete(id, el) {
            document.querySelectorAll('.sugestao-item').forEach(i => i.classList.remove('selecionado'));
            el.classList.add('selecionado');
            piqueteSelecionado = id;
        }
        
        function confirmarMovimentacao() {
            if (!piqueteSelecionado) return alert('Selecione um piquete!');
            fetch(`/api/lotes/${document.getElementById('mover-lote-id').value}/mover?fazenda_id=${fazendaId}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ piquete_destino_id: piqueteSelecionado })
            }).then(r => r.json()).then(data => {
                if (data.status === 'ok') { fecharModal('modal-mover'); carregarLotes(); alert('Lote movido!'); piqueteSelecionado = null; }
            });
        }
        
        function registrarSaida(loteId) {
            if (!confirm('Registrar saÃ­da do lote?')) return;
            fetch(`/api/lotes/${loteId}/sair?fazenda_id=${fazendaId}`, {method: 'POST'})
                .then(r => r.json()).then(data => { if (data.status === 'ok') carregarLotes(); });
        }
        
        function abrirModalEditar(loteId) {
            const lote = lotes.find(l => l.id === loteId);
            if (!lote) return;
            document.getElementById('edit-lote-id').value = lote.id;
            document.getElementById('edit-lote-nome').value = lote.nome;
            document.getElementById('edit-lote-categoria').value = lote.categoria || '';
            document.getElementById('edit-lote-quantidade').value = lote.quantidade || 1;
            document.getElementById('edit-lote-peso').value = lote.peso_medio || 0;
            document.getElementById('aviso-piquete-recuperacao').style.display = 'none';
            window.personalizadoParamsEdit = lote.categoria === 'Personalizado' ? { peso_medio: lote.peso_medio, consumo_base: lote.consumo_base } : null;
            
            fetch('/api/piquetes/disponiveis?fazenda_id=' + fazendaId)
                .then(r => r.json()).then(data => {
                    const select = document.getElementById('edit-lote-piquete');
                    let html = '<option value="">ğŸš« Sem piquete</option>';
                    data.forEach(p => {
                        const alturaUsada = p.altura_real_medida !== null ? p.altura_real_medida : p.altura_estimada;
                        const isRecuperando = !p.bloqueado && alturaUsada < p.altura_entrada;
                        html += `<option value="${p.id}" ${lote.piquete_atual_id === p.id ? 'selected' : ''} style="${isRecuperando ? 'background:#f8d7da;' : ''}">${p.nome} (${p.capim || 'N/I'}) ${p.bloqueado ? 'ğŸ”´' : (alturaUsada >= p.altura_entrada ? 'ğŸŸ¢' : 'ğŸŸ¡')} â€¢ ${p.dias_descanso || 0}/${p.dias_ideais || 30} dias</option>`;
                    });
                    select.innerHTML = html;
                });
            document.getElementById('modal-editar').classList.add('active');
        }
        
        function verificarPiqueteRecuperacao() {
            const id = document.getElementById('edit-lote-piquete').value;
            if (!id) { document.getElementById('aviso-piquete-recuperacao').style.display = 'none'; return; }
            fetch('/api/piquetes/' + id).then(r => r.json()).then(p => {
                const emRecup = p.altura_atual && p.altura_atual < p.altura_entrada && !p.bloqueado;
                document.getElementById('aviso-piquete-recuperacao').style.display = emRecup ? 'block' : 'none';
            });
        }
        
        function limparPiqueteEdicao() { document.getElementById('edit-lote-piquete').value = ''; document.getElementById('aviso-piquete-recuperacao').style.display = 'none'; }
        
        function abrirModalDetalhes(loteId) {
            const lote = lotes.find(l => l.id === loteId);
            if (!lote) return;
            const pesoTotal = (lote.quantidade || 0) * (lote.peso_medio || 0);
            const ua = pesoTotal / 450;
            const statusCalc = lote.status_info ? lote.status_info.status : (lote.status_calculado || '');
            const diasPassados = calcularDiasPassados(lote.data_entrada);
            const dataFormatada = formatarData(lote.data_entrada);
            
            let html = `<div style="text-align:center;margin-bottom:20px;"><h2 style="color:#007bff;">${lote.nome}</h2><span class="status-badge ${statusCalc.toLowerCase()}">${statusCalc}</span></div>
                <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:20px;">
                    <div style="background:#e3f2fd;padding:15px;border-radius:10px;text-align:center;"><strong>${lote.quantidade || 0}</strong><br><small>Animais</small></div>
                    <div style="background:#fff3cd;padding:15px;border-radius:10px;text-align:center;"><strong>${ua.toFixed(2)}</strong><br><small>UA Total</small></div>
                    <div style="background:#28a745;color:white;padding:15px;border-radius:10px;text-align:center;"><strong>${(lote.peso_medio || 0).toFixed(0)}</strong><br><small>Peso MÃ©dio</small></div>
                </div>
                <div style="background:#f8f9fa;padding:15px;border-radius:10px;margin-bottom:15px;">
                    <strong>ğŸ“ Piquete:</strong> ${lote.piquete_nome || 'Sem piquete'}<br>
                    <strong>ğŸ“… Entrada:</strong> ${dataFormatada || '-'}<br>
                    <strong>â±ï¸ Dias no Piquete:</strong> ${diasPassados !== null ? diasPassados : '-'}<br>
                    <strong>ğŸ“‹ Categoria:</strong> ${lote.categoria || '-'}
                </div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                    <button class="btn btn-primary" onclick="fecharModal('modal-detalhes'); abrirModalEditar(${lote.id});">âœï¸ Editar</button>
                    <button class="btn btn-warning" onclick="fecharModal('modal-detalhes'); registrarSaida(${lote.id});">ğŸ“¤ Sair</button>
                </div>`;
            document.getElementById('detalhes-lote-conteudo').innerHTML = html;
            document.getElementById('modal-detalhes').classList.add('active');
        }
        
        function salvarEdicaoLote() {
            const id = document.getElementById('edit-lote-id').value;
            const payload = {
                nome: document.getElementById('edit-lote-nome').value,
                categoria: document.getElementById('edit-lote-categoria').value,
                quantidade: parseInt(document.getElementById('edit-lote-quantidade').value) || 1,
                peso_medio: parseFloat(document.getElementById('edit-lote-peso').value) || 0,
                piquete_atual_id: document.getElementById('edit-lote-piquete').value || null
            };
            fetch(`/api/lotes/${id}`, { method: 'PUT', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) })
                .then(r => r.json()).then(data => { if (data.status === 'ok') { fecharModal('modal-editar'); carregarLotes(); alert('Lote atualizado!'); } });
        }
        
        function excluirLote() {
            const id = document.getElementById('edit-lote-id').value;
            if (!confirm(`Excluir lote?`)) return;
            fetch(`/api/lotes/${id}`, {method: 'DELETE'}).then(r => r.json()).then(data => { if (data.status === 'ok') { fecharModal('modal-editar'); carregarLotes(); } });
        }
        
        function atualizarStatus() {
            fetch(`/api/lotes/atualizar-status?fazenda_id=${fazendaId}`, {method: 'POST'}).then(r => r.json()).then(data => { if (data.status === 'ok') carregarLotes(); });
        }
        
        function abrirModalTodosPiquetes(loteId) {
            document.getElementById('modal-todos-piquetes').classList.add('active');
            fetch(`/api/lotes/${loteId}/sugerir-piquetes?fazenda_id=${fazendaId}`)
                .then(r => r.json()).then(data => {
                    const container = document.getElementById('lista-todos-piquetes');
                    container.innerHTML = data.map(p => `
                        <div class="sugestao-item ${p.status === 'APTO' ? 'apto' : 'quase'}" onclick="selecionarPiquete(${p.id}, this)">
                            <div class="sugestao-header"><span class="sugestao-nome">${p.nome}</span><span class="sugestao-badge ${p.status === 'APTO' ? 'badge-apto' : 'badge-quase'}">${p.status}</span></div>
                            <div class="sugestao-info">${p.capim} â€¢ ${p.area} ha â€¢ ${p.dias_descanso} dias descanso</div>
                        </div>
                    `).join('');
                });
        }
        
        function fecharModal(id) { document.getElementById(id).classList.remove('active'); }
        function fecharModalLote() { fecharModal('modal-lote'); }
    </script>
</body>
</html>