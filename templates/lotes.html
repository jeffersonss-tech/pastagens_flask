<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lotes - PastoFlow</title>
    <link rel="icon" type="image/x-icon" href="/static/icon/PastoFlow-logo.ico">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: system-ui, sans-serif; background: #f0f2f5; }
        
        /* Header */
        .header {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header h1 { font-size: 1.4rem; }
        .header a { color: #00d9ff; text-decoration: none; }
        
        /* Content */
        .content { padding: 25px; }
        
        /* Stats Cards */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .stat-card strong { display: block; font-size: 2rem; margin-bottom: 5px; }
        .stat-card.animais strong { color: #007bff; }
        .stat-card.ocupacao strong { color: #fd7e14; }
        .stat-card.saida strong { color: #dc3545; }
        .stat-card.disponivel strong { color: #28a745; }
        .stat-card span { color: #666; font-size: 0.85rem; }
        
        /* Filters */
        .filters {
            background: white;
            padding: 15px 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        .filters label { font-size: 0.85rem; color: #666; }
        .filters select {
            padding: 8px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 0.9rem;
        }
        .filters button {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85rem;
        }
        .btn-primary { background: #00d9ff; color: #1a1a2e; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: #333; }
        .btn-danger { background: #dc3545; color: white; }
        
        /* Tabela */
        .table-container {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .table-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .table-header h2 { font-size: 1.1rem; color: #1a1a2e; }
        
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 15px 20px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f8f9fa; font-size: 0.85rem; color: #666; font-weight: 500; }
        tr:hover { background: #f8f9fa; }
        
        /* Status Badges */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        .status-badge.ok { background: #d4edda; color: #155724; }
        .status-badge.atencao { background: #fff3cd; color: #856404; }
        .status-badge.retirar { background: #f8d7da; color: #721c24; }
        .status-badge.bloqueado { background: #e2d5f1; color: #4a2c7a; }
        .status-badge.sem-piquete { background: #e9ecef; color: #666; }
        .status-badge.aguardando { background: #cce5ff; color: #004085; }
        .status-badge.ocupacao { background: #d1ecf1; color: #0c5460; border: 1px solid #17a2b8; }
        
        /* Dias */
        .dias-info { font-size: 0.9rem; }
        .dias-info .atual { font-weight: bold; }
        .dias-info .limite { color: #999; }
        .dias-info .atual.over { color: #dc3545; }
        .dias-info .atual.near { color: #fd7e14; }
        
        /* Actions */
        .actions { display: flex; gap: 8px; }
        .actions button {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
        }
        .btn-mover { background: #007bff; color: white; }
        .btn-sair { background: #fd7e14; color: white; }
        .btn-ver { background: #6c757d; color: white; }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: white;
            border-radius: 15px;
            width: 500px;
            max-width: 95%;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-header h3 { color: #1a1a2e; }
        .modal-close { background: none; border: none; font-size: 1.5rem; cursor: pointer; }
        .modal-body { padding: 20px; }
        
        /* Lot name clickable */
        td[style*="cursor: pointer"]:hover {
            background-color: #f0f7ff;
        }
        td[style*="cursor: pointer"] strong {
            text-decoration: underline;
        }
        
        /* Form */
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; color: #666; font-size: 0.85rem; margin-bottom: 5px; }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 0.95rem;
        }
        
        /* Sugest√µes de Piquete */
        .sugestao-item {
            padding: 12px;
            border: 2px solid #eee;
            border-radius: 10px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .sugestao-item:hover { border-color: #00d9ff; background: #f8f9fa; }
        .sugestao-item.apto { border-left: 4px solid #28a745; }
        .sugestao-item.quase { border-left: 4px solid #ffc107; }
        .sugestao-item.selecionado { border-color: #007bff; background: #e7f3ff; }
        
        .sugestao-header { display: flex; justify-content: space-between; align-items: center; }
        .sugestao-nome { font-weight: 600; color: #1a1a2e; }
        .sugestao-info { font-size: 0.85rem; color: #666; margin-top: 5px; }
        .sugestao-badge {
            padding: 3px 10px;
            border-radius: 15px;
            font-size: 0.75rem;
            font-weight: bold;
        }
        .badge-apto { background: #d4edda; color: #155724; }
        .badge-quase { background: #fff3cd; color: #856404; }
        
        /* Buttons */
        .btn-edit {
            padding: 6px 12px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
        }
        .btn-edit:hover { background: #5a6268; }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }
        .empty-state h3 { margin-bottom: 10px; color: #1a1a2e; }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div>
            <h1>üêÑ Lotes</h1>
            <p style="opacity: 0.8; font-size: 0.9rem;">{{ fazenda.nome }}</p>
        </div>
        <a href="/fazenda/{{ fazenda.id }}">‚Üê Voltar</a>
    </div>
    
    <div class="content">
        <!-- Stats -->
        <div class="stats-row">
            <div class="stat-card animais">
                <strong id="stat-total">0</strong>
                <span>üêÑ Total de Lotes</span>
            </div>
            <div class="stat-card ocupacao">
                <strong id="stat-ocupacao">0</strong>
                <span>üìç Em Ocupa√ß√£o</span>
            </div>
            <div class="stat-card saida">
                <strong id="stat-saida">0</strong>
                <span>‚ö†Ô∏è Precisa Sair</span>
            </div>
            <div class="stat-card disponivel">
                <strong id="stat-animais">0</strong>
                <span>üêÉ Total Animais</span>
            </div>
        </div>
        
        <!-- Filters -->
        <div class="filters">
            <label>Status:</label>
            <select id="filtro-status" onchange="carregarLotes()">
                <option value="">Todos</option>
                <option value="OK">üü¢ OK</option>
                <option value="ATENCAO">üü† Aten√ß√£o</option>
                <option value="RETIRAR">üî¥ Retirar</option>
                <option value="AGUARDANDO_ALOCACAO">üîµ Aguardando Aloca√ß√£o</option>
            </select>
            
            <label>Categoria:</label>
            <select id="filtro-categoria" onchange="carregarLotes()">
                <option value="">Todas</option>
                <option value="Bezerro(a)">Bezerro(a)</option>
                <option value="Garrote / Novilho(a)">Garrote / Novilho(a)</option>
                <option value="Boi Magro / Engorda">Boi Magro / Engorda</option>
                <option value="Vaca">Vaca</option>
                <option value="Touro">Touro</option>
            </select>
            
            <button class="btn btn-warning" onclick="atualizarStatus()">üîÑ Atualizar Status</button>
            <button class="btn btn-primary" onclick="abrirModalNovoLote()">‚ûï Novo Lote</button>
        </div>
        
        <!-- Tabela -->
        <div class="table-container">
            <div class="table-header">
                <h2>üìã Lotes Ativos</h2>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>üêÇ Lote</th>
                        <th>üìç Piquete Atual</th>
                        <th>‚è±Ô∏è Dias T√©cnicos</th>
                        <th>üìä Status</th>
                        <th>üìã Pr√≥ximos</th>
                        <th>‚öôÔ∏è A√ß√µes</th>
                    </tr>
                </thead>
                <tbody id="lista-lotes">
                    <tr>
                        <td colspan="6" class="empty-state">
                            <h3>Carregando...</h3>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    
    <!-- Modal Par√¢metros Personalizado (z-index maior para ficar por cima) -->
    <div class="modal" id="modal-personalizado" style="z-index: 2000;">
        <div class="modal-content" style="width: 400px; z-index: 2001;">
            <div class="modal-header">
                <h3>‚öôÔ∏è Par√¢metros T√©cnicos</h3>
                <button class="modal-close" onclick="fecharModal('modal-personalizado')">√ó</button>
            </div>
            <div class="modal-body">
                <p style="color: #666; font-size: 0.9rem; margin-bottom: 15px;">
                    Informe os par√¢metros t√©cnicos para categoria <strong>Personalizado</strong>:
                </p>
                
                <div class="form-group">
                    <label>Peso M√©dio (kg) *</label>
                    <input type="number" id="param-peso-medio" placeholder="Ex: 350" step="0.1" min="50" max="1200">
                </div>
                
                <div class="form-group">
                    <label>Consumo Base (cm/dia em 2 UA/ha)</label>
                    <input type="number" id="param-consumo-base" value="0.8" step="0.05" min="0.1" max="3.0">
                    <small style="color: #666; font-size: 0.75rem;">Quanto o pasto √© consumido por animal por dia</small>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px;">
                    <button class="btn" style="background: #6c757d; color: white;" onclick="fecharModal('modal-personalizado')">Cancelar</button>
                    <button class="btn btn-success" onclick="confirmarPersonalizado()">Confirmar</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal Novo Lote -->
    <div class="modal" id="modal-novo-lote">
        <div class="modal-content">
            <div class="modal-header">
                <h3>‚ûï Novo Lote</h3>
                <button class="modal-close" onclick="fecharModal('modal-novo-lote')">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Nome do Lote *</label>
                    <input type="text" id="lote-nome" placeholder="Ex: Lote A, Recria 2024">
                </div>
                <div class="form-group">
                    <label>Categoria</label>
                    <select id="lote-categoria" onchange="verificarPersonalizado()">
                        <option value="Bezerro(a)">Bezerro(a) - 200kg</option>
                        <option value="Garrote / Novilho(a)">Garrote / Novilho(a) - 325kg</option>
                        <option value="Boi Magro / Engorda">Boi Magro / Engorda - 475kg</option>
                        <option value="Vaca">Vaca - 500kg</option>
                        <option value="Touro">Touro - 850kg</option>
                        <option value="Personalizado">‚≠ê Personalizado</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Quantidade de Animais</label>
                    <input type="number" id="lote-quantidade" value="1" min="1">
                </div>
                <div class="form-group">
                    <label>Peso M√©dio (kg)</label>
                    <input type="number" id="lote-peso" value="0" step="0.1">
                </div>
                <div class="form-group">
                    <label>Piquete de Entrada (opcional)</label>
                    <select id="lote-piquete">
                        <option value="">Nenhum (lote sem piquete)</option>
                    </select>
                </div>
                <button class="btn btn-success" style="width: 100%;" onclick="salvarLote()">üíæ Criar Lote</button>
            </div>
        </div>
    </div>
    
    <!-- Modal Editar Lote -->
    <div class="modal" id="modal-editar">
        <div class="modal-content" style="width: 450px;">
            <div class="modal-header">
                <h3>‚úèÔ∏è Editar Lote</h3>
                <button class="modal-close" onclick="fecharModal('modal-editar')">√ó</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="edit-lote-id">
                
                <div class="form-group">
                    <label>Nome do Lote *</label>
                    <input type="text" id="edit-lote-nome" required>
                </div>
                
                <div class="form-group">
                    <label>Categoria</label>
                    <select id="edit-lote-categoria" onchange="verificarPersonalizadoEdit(); atualizarPesoMedioEdit();">
                        <option value="">Selecione...</option>
                        <option value="Bezerro(a)">Bezerro(a) - 200kg</option>
                        <option value="Garrote / Novilho(a)">Garrote / Novilho(a) - 325kg</option>
                        <option value="Boi Magro / Engorda">Boi Magro / Engorda - 475kg</option>
                        <option value="Vaca">Vaca - 500kg</option>
                        <option value="Touro">Touro - 850kg</option>
                        <option value="Personalizado">‚≠ê Personalizado</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Quantidade de Animais</label>
                    <input type="number" id="edit-lote-quantidade" value="1" min="1">
                </div>
                
                <div class="form-group">
                    <label>Peso M√©dio (kg)</label>
                    <input type="number" id="edit-lote-peso" value="0" step="0.1">
                </div>
                
                <div class="form-group">
                    <label>Piquete Atual (opcional)</label>
                    <select id="edit-lote-piquete" onchange="verificarPiqueteRecuperacao()">
                        <option value="">Sem piquete</option>
                    </select>
                </div>
                
                <div id="aviso-piquete-recuperacao" style="display: none; background: #f8d7da; border: 2px solid #dc3545; border-radius: 8px; padding: 12px; margin-bottom: 15px; text-align: center;">
                    <strong style="color: #dc3545;">üö® AVISO!</strong><br>
                    <small style="color: #721c24;">Este piquete est√° em RECUPERA√á√ÉO!</small><br>
                    <small style="color: #721c24;">Animais n√£o deveriam estar aqui. Considere outro piquete.</small>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 20px;">
                    <button class="btn btn-primary" onclick="salvarEdicaoLote()">üíæ Salvar</button>
                    <button class="btn btn-warning" onclick="limparPiqueteEdicao()">üö´ Sem Piquete</button>
                    <button class="btn btn-danger" onclick="excluirLote()">üóëÔ∏è Excluir</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal Mover -->
    <div class="modal" id="modal-mover">
        <div class="modal-content">
            <div class="modal-header">
                <h3>‚û°Ô∏è Mover Lote</h3>
                <button class="modal-close" onclick="fecharModal('modal-mover')">√ó</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="mover-lote-id">
                
                <div style="margin-bottom: 15px; padding: 10px; background: #f8f9fa; border-radius: 8px;">
                    <strong>Lote:</strong> <span id="mover-lote-nome"></span>
                </div>
                
                <h4 style="margin-bottom: 15px;">Selecione o piquete de destino:</h4>
                <p style="color: #666; font-size: 0.85rem; margin-bottom: 15px;">
                    üí° Apenas piquetes APONTOS s√£o mostrados.
                </p>
                
                <div id="sugestoes-piquetes" style="margin-bottom: 15px;"></div>
                
                <div id="sem-piquetes-aptos" style="display: none; text-align: center; padding: 20px; color: #dc3545;">
                    ‚ö†Ô∏è Nenhum piquete dispon√≠vel no momento!
                </div>
                
                <button class="btn btn-success" style="width: 100%; margin-top: 15px;" onclick="confirmarMovimentacao()">
                    ‚úÖ Confirmar Movimenta√ß√£o
                </button>
            </div>
        </div>
    </div>
    
    <!-- Modal Ver Todos os Piquetes -->
    <div class="modal" id="modal-todos-piquetes">
        <div class="modal-content" style="width: 500px;">
            <div class="modal-header">
                <h3>üìã Piquetes Dispon√≠veis</h3>
                <button class="modal-close" onclick="fecharModal('modal-todos-piquetes')">√ó</button>
            </div>
            <div class="modal-body">
                <p style="color: #666; font-size: 0.85rem; margin-bottom: 15px;">
                    üí° Piquetes ordenados por prioridade (aptos primeiro)
                </p>
                <div id="lista-todos-piquetes" style="max-height: 400px; overflow-y: auto;"></div>
            </div>
        </div>
    </div>
    
    <!-- Modal Ver Detalhes do Lote -->
    <div class="modal" id="modal-detalhes">
        <div class="modal-content" style="width: 550px;">
            <div class="modal-header">
                <h3>üìã Detalhes do Lote</h3>
                <button class="modal-close" onclick="fecharModal('modal-detalhes')">√ó</button>
            </div>
            <div class="modal-body" id="detalhes-lote-conteudo">
                <!-- Conte√∫do preenchido via JavaScript -->
            </div>
        </div>
    </div>
    
    <script>
        const fazendaId = {{ fazenda.id }};
        let lotes = [];
        
        // Pesos m√©dios por categoria
        const pesosCategorias = {
            'Bezerro(a)': 200,
            'Garrote / Novilho(a)': 325,
            'Boi Magro / Engorda': 475,
            'Vaca': 500,
            'Touro': 850,
            'Personalizado': null
        };
        
        // Fun√ß√£o para calcular dias passados desde a entrada
        function calcularDiasPassados(dataEntrada) {
            if (!dataEntrada) return null;
            try {
                const entrada = new Date(dataEntrada);
                const agora = new Date();
                const diffTime = Math.abs(agora - entrada);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                return diffDays;
            } catch (e) {
                return null;
            }
        }
        
        // Fun√ß√£o para formatar data para DD/MM/AAAA
        function formatarData(dataEntrada) {
            if (!dataEntrada) return null;
            try {
                const date = new Date(dataEntrada);
                const dia = String(date.getDate()).padStart(2, '0');
                const mes = String(date.getMonth() + 1).padStart(2, '0');
                const ano = date.getFullYear();
                return `${dia}/${mes}/${ano}`;
            } catch (e) {
                return null;
            }
        }
        
        // Fun√ß√£o para verificar se √© Personalizado e abrir modal
        let categoriaSelecionada = '';
        function verificarPersonalizado() {
            const select = document.getElementById('lote-categoria');
            if (select.value === 'Personalizado') {
                // Limpar o campo de peso e abrir modal de par√¢metros
                document.getElementById('lote-peso').value = '';
                document.getElementById('modal-personalizado').classList.add('active');
            } else {
                // Para categorias normais, auto-preencher o peso
                atualizarPesoMedio('lote');
            }
        }
        
        // Fun√ß√£o para verificar Personalizado na edi√ß√£o
        function verificarPersonalizadoEdit() {
            const select = document.getElementById('edit-lote-categoria');
            if (select.value === 'Personalizado') {
                // Limpar o campo de peso e abrir modal de par√¢metros
                document.getElementById('edit-lote-peso').value = '';
                document.getElementById('modal-personalizado').classList.add('active');
                // Preencher com valores atuais se existirem
                const pesoEdit = document.getElementById('edit-lote-peso').value;
                if (pesoEdit && pesoEdit > 0) {
                    document.getElementById('param-peso-medio').value = pesoEdit;
                }
            } else {
                // Para categorias normais, auto-preencher o peso
                atualizarPesoMedio('edit');
            }
        }
        
        // Fun√ß√£o para confirmar Personalizado na edi√ß√£o
        function confirmarPersonalizadoEdit() {
            const peso = parseFloat(document.getElementById('param-peso-medio').value) || 0;
            const consumo = parseFloat(document.getElementById('param-consumo-base').value) || 0.8;
            
            if (!peso || peso < 50 || peso > 1200) {
                alert('Peso m√©dio deve ser entre 50 e 1200 kg');
                return;
            }
            
            window.personalizadoParamsEdit = {
                peso_medio: peso,
                consumo_base: consumo
            };
            
            document.getElementById('edit-lote-peso').value = peso;
            fecharModal('modal-personalizado');
        }
        
        // Sobrescrever confirmarPersonalizado para edi√ß√£o tamb√©m
        function confirmarPersonalizado() {
            const peso = parseFloat(document.getElementById('param-peso-medio').value) || 0;
            const consumo = parseFloat(document.getElementById('param-consumo-base').value) || 0.8;
            
            if (!peso || peso < 50 || peso > 1200) {
                alert('Peso m√©dio deve ser entre 50 e 1200 kg');
                return;
            }
            if (consumo < 0.1 || consumo > 3.0) {
                alert('Consumo base deve ser entre 0.1 e 3.0 cm/dia');
                return;
            }
            
            window.personalizadoParams = {
                peso_medio: peso,
                consumo_base: consumo
            };
            
            document.getElementById('lote-peso').value = peso;
            fecharModal('modal-personalizado');
        }
        
        // Fun√ß√£o espec√≠fica para mostrar/ocultar campos de Personalizado
        function togglePersonalizado(prefixo) {
            // N√£o usado mais - agora usa modal separado
        }
        
        // Fun√ß√£o para atualizar peso m√©dio baseado na categoria (CRIA√á√ÉO)
        function atualizarPesoMedio() {
            const categoriaSelect = document.getElementById('lote-categoria');
            const pesoInput = document.getElementById('lote-peso');
            
            if (!categoriaSelect || !pesoInput) return;
            
            const categoria = categoriaSelect.value;
            if (categoria === 'Personalizado') return;
            
            const peso = pesosCategorias[categoria];
            if (peso !== undefined && peso !== null) {
                pesoInput.value = peso;
            }
        }
        
        // Fun√ß√£o para atualizar peso m√©dio (EDI√á√ÉO)
        function atualizarPesoMedioEdit() {
            const categoriaSelect = document.getElementById('edit-lote-categoria');
            const pesoInput = document.getElementById('edit-lote-peso');
            
            if (!categoriaSelect || !pesoInput) return;
            
            const categoria = categoriaSelect.value;
            if (categoria === 'Personalizado') return;
            
            const peso = pesosCategorias[categoria];
            if (peso !== undefined && peso !== null) {
                pesoInput.value = peso;
            }
        }
        
        // Carregar tudo ao iniciar
        window.onload = function() {
            carregarLotes();
            carregarPiquetesSelect();
            
            // Auto-refresh a cada 30 segundos para manter status atualizado
            setInterval(() => {
                carregarLotes();
                carregarPiquetesSelect();
            }, 30000);
            
            // Atualizar ao ganhar foco (quando usu√°rio volta da aba de piquetes)
            document.addEventListener('visibilitychange', () => {
                if (!document.hidden) {
                    carregarLotes();
                    carregarPiquetesSelect();
                }
            });
        };
        
        function carregarLotes() {
            const status = document.getElementById('filtro-status').value;
            const categoria = document.getElementById('filtro-categoria').value;
            
            fetch(`/api/lotes?fazenda_id=${fazendaId}&status=${status}&categoria=${categoria}`)
                .then(r => r.json())
                .then(data => {
                    lotes = data;
                    renderizarTabela();
                    atualizarStats();
                });
        }
        
        function atualizarStats() {
            document.getElementById('stat-total').textContent = lotes.length;
            
            const emOcupacao = lotes.filter(l => l.piquete_atual_id).length;
            document.getElementById('stat-ocupacao').textContent = emOcupacao;
            
            // CORRE√á√ÉO: Usar status_info (calculado) em vez de status_calculado (cache)
            const precisaSair = lotes.filter(l => l.piquete_atual_id && (l.status_info?.status === 'RETIRAR')).length;
            document.getElementById('stat-saida').textContent = precisaSair;
            
            const totalAnimais = lotes.reduce((sum, l) => sum + (l.quantidade || 0), 0);
            document.getElementById('stat-animais').textContent = totalAnimais;
        }
        
        function renderizarTabela() {
            const tbody = document.getElementById('lista-lotes');
            
            if (lotes.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="empty-state">
                            <h3>üòï Nenhum lote encontrado</h3>
                            <p>Cadastre o primeiro lote ou ajuste os filtros.</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Buscar sugestoes para cada lote com fazenda_id
            Promise.all(lotes.map(l => 
                fetch(`/api/lotes/${l.id}/sugerir-piquetes?fazenda_id=${fazendaId}`).then(r => r.json())
            )).then(sugestoesArrays => {
                const sugestoesMap = {};
                lotes.forEach((l, i) => {
                    sugestoesMap[l.id] = sugestoesArrays[i];
                });
                
                tbody.innerHTML = lotes.map((lote, idx) => {
                    const sugestoes = sugestoesMap[lote.id] || [];
                    const temPiquete = !!lote.piquete_atual_id;
                    const diasTecnicos = lote.dias_tecnicos || 0;
                    
                    // CORRE√á√ÉO 1: Status - Aguardando Aloca√ß√£o se sem piquete
                    let statusBadge = '';
                    // Usar status_info (calculado dinamicamente) em vez de status_calculado (cache)
                    const statusCalc = lote.status_info ? lote.status_info.status : (lote.status_calculado || '');
                    
                    if (!temPiquete) {
                        statusBadge = '<span class="status-badge aguardando">üîµ Aguardando Aloca√ß√£o</span>';
                    } else {
                        switch(statusCalc) {
                            case 'RETIRAR':
                                statusBadge = '<span class="status-badge retirar">üî¥ Retirar</span>';
                                break;
                            case 'ATENCAO':
                                statusBadge = '<span class="status-badge atencao">üü† Aten√ß√£o</span>';
                                break;
                            default:
                                // Lote em ocupacao e OK - Status diferenciado
                                statusBadge = '<span class="status-badge ocupacao">üîµ Em Ocupa√ß√£o</span>';
                        }
                    }
                    
                    // CORRE√á√ÉO 2: Dias - "‚Äî" se sem piquete
                    let diasHtml = '';
                    if (!temPiquete) {
                        diasHtml = '<span style="color: #999;">‚Äî</span>';
                    } else {
                        const diasPassados = calcularDiasPassados(lote.data_entrada);
                        const dataFormatada = formatarData(lote.data_entrada);
                        const diasRestantes = Math.max(0, diasTecnicos - diasPassados);
                        
                        diasHtml = `
                            <div class="dias-info">
                                <span class="atual">${diasTecnicos}</span> dias t√©cnicos
                                ${dataFormatada ? `<br><small style="color: #666;">üìÖ Entrada: ${dataFormatada}</small>` : ''}
                                ${diasPassados !== null ? `<br><small style="color: #007bff;">‚è±Ô∏è ${diasPassados} dia(s)</small>` : ''}
                                ${diasRestantes > 0 ? `<br><small style="color: #28a745;">üìä ${diasRestantes} dias restantes</small>` : ''}
                            </div>
                        `;
                    }
                    
                    // Piquete atual - mostrar estimada
                    let piqueteInfo = temPiquete 
                        ? `${lote.piquete_nome}<br><small style="color: #28a745;">üìè ${lote.altura_estimada || '?'}cm</small>`
                        : '<span style="color: #999;">Sem piquete</span>';
                    
                    // CORRE√á√ÉO 5: Pr√≥ximo piquete - bot√£o para ver todos
                    let proximoHtml = '';
                    if (sugestoes.length > 0) {
                        // Contar aptos e em recupera√ß√£o
                        const aptos = sugestoes.filter(p => p.status === 'APTO' || p.status === 'APTO_ALCANCADA').length;
                        const emRecup = sugestoes.filter(p => p.status === 'RECUPERANDO').length;
                        
                        proximoHtml = `
                            <button class="btn btn-sm" style="background: #6c757d; color: white;" 
                                    onclick="abrirModalTodosPiquetes(${lote.id})">
                                üìã Ver ${sugestoes.length} op√ß√µes
                            </button>
                            <br><small style="color: #28a745;">üü¢ ${aptos} aptos</small>
                            ${emRecup > 0 ? `<br><small style="color: #856404;">üü° ${emRecup} em recup.</small>` : ''}
                        `;
                    } else {
                        proximoHtml = `
                            <span style="font-size: 0.85rem; color: #999;">‚ö†Ô∏è Nenhum dispon√≠vel</span>
                        `;
                    }
                    
                    // CORRE√á√ÉO 4: Bot√µes - orienta√ß√£o clara do que fazer
                    let actions = '';
                    const aptos = sugestoes.filter(p => p.status === 'APTO' || p.status === 'APTO_ALCANCADA');
                    const emRecuperando = sugestoes.filter(p => p.status === 'RECUPERANDO');
                    
                    if (temPiquete && aptos.length > 0) {
                        actions = `
                            <button class="btn-mover" onclick="abrirModalMover(${lote.id}, '${lote.nome}')">‚û°Ô∏è Mover</button>
                            <button class="btn-sair" onclick="registrarSaida(${lote.id})">üì§ Sair</button>
                            <button class="btn-edit" onclick="abrirModalEditar(${lote.id})">‚úèÔ∏è Edit</button>
                        `;
                    } else if (temPiquete) {
                        actions = `
                            <button class="btn-sair" onclick="registrarSaida(${lote.id})">üì§ Sair</button>
                            <button class="btn-edit" onclick="abrirModalEditar(${lote.id})">‚úèÔ∏è Edit</button>
                        `;
                    } else if (aptos.length > 0) {
                        actions = `
                            <button class="btn-mover" onclick="abrirModalMover(${lote.id}, '${lote.nome}')">‚û°Ô∏è Alocar</button>
                            <button class="btn-edit" onclick="abrirModalEditar(${lote.id})">‚úèÔ∏è Edit</button>
                        `;
                    } else if (emRecuperando.length > 0) {
                        actions = `
                            <button class="btn-edit" onclick="abrirModalEditar(${lote.id})">‚úèÔ∏è Edit</button>
                            <span style="font-size: 0.75rem; color: #856404;">üìè RECUPERANDO</span>
                        `;
                    } else {
                        actions = `
                            <div style="text-align: center;">
                                <span style="font-size: 0.8rem; color: #666;">Nenhum piquete</span>
                                <br><button class="btn-edit" onclick="abrirModalEditar(${lote.id})" style="margin-top: 5px;">‚úèÔ∏è Editar</button>
                            </div>
                        `;
                    }
                    
                    return `
                        <tr>
                            <td style="cursor: pointer;" onclick="abrirModalDetalhes(${lote.id})">
                                <strong style="color: #007bff;">${lote.nome}</strong><br>
                                <small style="color: #666;">${lote.categoria || '-'} ‚Ä¢ ${lote.quantidade || 0} animai(s)</small>
                            </td>
                            <td>${piqueteInfo}</td>
                            <td>${diasHtml}</td>
                            <td>${statusBadge}</td>
                            <td>${proximoHtml}</td>
                            <td>${actions}</td>
                        </tr>
                    `;
                }).join('');
                
                // Atualizar stat - usar status_info (calculado)
                const precisaSair = lotes.filter(l => l.piquete_atual_id && (l.status_info?.status === 'RETIRAR')).length;
                document.getElementById('stat-saida').textContent = precisaSair;
            });
        }
        
        function carregarPiquetesSelect() {
            // Usar API de piquetes dispon√≠veis (sem animais)
            fetch('/api/piquetes/disponiveis?fazenda_id=' + fazendaId)
                .then(r => r.json())
                .then(data => {
                    const select = document.getElementById('lote-piquete');
                    // Mostrar piquetes dispon√≠veis com dias de descanso
                    select.innerHTML = '<option value="">Nenhum (lote sem piquete)</option>' +
                        data.map(p => {
                            // Usar altura_real_medida ou altura_estimada
                            const temReal = p.altura_real_medida !== null && p.altura_real_medida !== undefined;
                            const alturaUsada = temReal ? p.altura_real_medida : p.altura_estimada;
                            const fonte = temReal ? 'MEDIDA' : 'ESTIMADA';
                            const diasDescanso = p.dias_descanso || 0;
                            const diasIdeais = p.dias_ideais || 30;
                            
                            const emoji = p.bloqueado ? 'üî¥' : (alturaUsada >= p.altura_entrada ? 'üü¢' : 'üü°');
                            const status = p.bloqueado ? 'BLOQUEADO' : (alturaUsada >= p.altura_entrada ? 'APTO' : 'RECUPERANDO');
                            return `<option value="${p.id}">${p.nome} (${p.capim || 'N/I'}) ${emoji} ${status} [${fonte}] ‚Ä¢ ${diasDescanso}/${diasIdeais} dias</option>`;
                        }).join('');
                });
        }
        
        function abrirModalNovoLote() {
            // Limpar par√¢metros do Personalizado anterior
            window.personalizadoParams = null;
            document.getElementById('lote-nome').value = '';
            document.getElementById('lote-quantidade').value = '1';
            
            // Resetar categoria para primeira op√ß√£o e preencher peso automaticamente
            document.getElementById('lote-categoria').selectedIndex = 0;
            document.getElementById('lote-peso').value = 200; // Bezerro = 200kg
            
            document.getElementById('modal-novo-lote').classList.add('active');
            carregarPiquetesSelect();
        }
        
        function salvarLote() {
            const nome = document.getElementById('lote-nome').value;
            if (!nome) return alert('Digite o nome do lote!');
            
            const categoria = document.getElementById('lote-categoria').value;
            let peso_medio = parseFloat(document.getElementById('lote-peso').value) || 0;
            
            // Se personalizado, usar par√¢metros do modal
            let consumo_base = null;
            if (categoria === 'Personalizado') {
                if (!window.personalizadoParams) {
                    return alert('Por favor, configure os par√¢metros t√©cnicos do Personalizado!');
                }
                peso_medio = window.personalizadoParams.peso_medio;
                consumo_base = window.personalizadoParams.consumo_base;
            }
            
            const payload = {
                nome: nome,
                categoria: categoria,
                quantidade: parseInt(document.getElementById('lote-quantidade').value) || 1,
                peso_medio: peso_medio,
                piquete_id: document.getElementById('lote-piquete').value || null
            };
            
            // Adicionar consumo_base se personalizado
            if (consumo_base !== null) {
                payload.consumo_base = consumo_base;
            }
            
            fetch('/api/lotes', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            }).then(r => r.json())
              .then(data => {
                  if (data.status === 'ok') {
                      fecharModal('modal-novo-lote');
                      carregarLotes();
                      alert('Lote criado com sucesso!');
                  }
              });
        }
        
        function abrirModalMover(loteId, nome) {
            document.getElementById('mover-lote-id').value = loteId;
            document.getElementById('mover-lote-nome').textContent = nome;
            document.getElementById('modal-mover').classList.add('active');
            
            // Carregar sugest√µes com fazenda_id
            fetch(`/api/lotes/${loteId}/sugerir-piquetes?fazenda_id=${fazendaId}`)
                .then(r => r.json())
                .then(data => {
                    const container = document.getElementById('sugestoes-piquetes');
                    const semAptos = document.getElementById('sem-piquetes-aptos');
                    
                    const aptos = data.filter(p => p.status === 'APTO' || p.status === 'APTO_ALCANCADA');
                    
                    if (aptos.length === 0) {
                        container.innerHTML = '';
                        semAptos.style.display = 'block';
                    } else {
                        semAptos.style.display = 'none';
                        container.innerHTML = aptos.map((p, i) => `
                            <div class="sugestao-item apto" onclick="selecionarPiquete(${p.id}, this)">
                                <div class="sugestao-header">
                                    <span class="sugestao-nome">${p.nome}</span>
                                    <span class="sugestao-badge badge-apto">üü¢ APTO</span>
                                </div>
                                <div class="sugestao-info">
                                    ${p.capim} ‚Ä¢ ${p.area} ha ‚Ä¢ ${p.dias_descanso} dias de descanso
                                </div>
                            </div>
                        `).join('');
                    }
                });
        }
        
        let piqueteSelecionado = null;
        function selecionarPiquete(id, el) {
            document.querySelectorAll('.sugestao-item').forEach(i => i.classList.remove('selecionado'));
            el.classList.add('selecionado');
            piqueteSelecionado = id;
        }
        
        function confirmarMovimentacao() {
            if (!piqueteSelecionado) return alert('Selecione um piquete!');
            
            fetch(`/api/lotes/${document.getElementById('mover-lote-id').value}/mover?fazenda_id=${fazendaId}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    piquete_destino_id: piqueteSelecionado
                })
            }).then(r => r.json())
              .then(data => {
                  if (data.status === 'ok') {
                      fecharModal('modal-mover');
                      carregarLotes();
                      alert('Lote movido com sucesso!');
                      piqueteSelecionado = null;
                  }
              });
        }
        
        function registrarSaida(loteId) {
            if (!confirm('Registrar sa√≠da do lote? Ele ficar√° sem piquete.')) return;
            
            fetch(`/api/lotes/${loteId}/sair?fazenda_id=${fazendaId}`, {method: 'POST'})
                .then(r => r.json())
                .then(data => {
                    if (data.status === 'ok') {
                        carregarLotes();
                    }
                });
        }
        
        function verDetalhes(loteId) {
            // TODO: Implementar modal de detalhes
            alert('Detalhes do lote: ' + loteId);
        }
        
        function abrirModalEditar(loteId) {
            const lote = lotes.find(l => l.id === loteId);
            if (!lote) return;
            
            document.getElementById('edit-lote-id').value = lote.id;
            document.getElementById('edit-lote-nome').value = lote.nome;
            document.getElementById('edit-lote-categoria').value = lote.categoria || '';
            document.getElementById('edit-lote-quantidade').value = lote.quantidade || 1;
            document.getElementById('edit-lote-peso').value = lote.peso_medio || 0;
            
            // Tratar campos de Personalizado
            const isPersonalizado = lote.categoria === 'Personalizado';
            const camposPersonalizado = document.getElementById('edit-campos-personalizado');
            if (camposPersonalizado) {
                camposPersonalizado.style.display = isPersonalizado ? 'block' : 'none';
            }
            // Preencher campos de personalizado
            if (isPersonalizado) {
                document.getElementById('edit-peso-personalizado').value = lote.peso_medio || '';
                document.getElementById('edit-consumo-base').value = lote.consumo_base || 0.8;
            }
            
            // Esconder aviso inicialmente
            document.getElementById('aviso-piquete-recuperacao').style.display = 'none';
            
            // Limpar par√¢metros do Personalizado anterior
            window.personalizadoParamsEdit = null;
            
            // Se Personalizado, configurar par√¢metros existentes
            if (lote.categoria === 'Personalizado') {
                window.personalizadoParamsEdit = {
                    peso_medio: lote.peso_medio || 0,
                    consumo_base: lote.consumo_base || 0.8
                };
            }
            
            // Carregar piquetes dispon√≠veis
            fetch('/api/piquetes/disponiveis?fazenda_id=' + fazendaId)
                .then(r => r.json())
                .then(data => {
                    const select = document.getElementById('edit-lote-piquete');
                    // Op√ß√£o "Sem piquete" primeiro
                    let html = '<option value="">üö´ Sem piquete</option>';
                    
                    // Mostrar piquetes dispon√≠veis com dias de descanso
                    data.forEach(p => {
                        const temReal = p.altura_real_medida !== null && p.altura_real_medida !== undefined;
                        const alturaUsada = temReal ? p.altura_real_medida : p.altura_estimada;
                        const fonte = temReal ? '[MEDIDA]' : '[ESTIMADA]';
                        const diasDescanso = p.dias_descanso || 0;
                        const diasIdeais = p.dias_ideais || 30;
                        
                        const emoji = p.bloqueado ? 'üî¥' : (alturaUsada >= p.altura_entrada ? 'üü¢' : 'üü°');
                        const status = p.bloqueado ? 'BLOQUEADO' : (alturaUsada >= p.altura_entrada ? 'APTO' : 'RECUPERANDO');
                        const isRecuperando = !p.bloqueado && alturaUsada < p.altura_entrada;
                        const selected = lote.piquete_atual_id === p.id ? 'selected' : '';
                        const dangerClass = isRecuperando ? 'background:#f8d7da;' : '';
                        html += `<option value="${p.id}" ${selected} style="${dangerClass}">${p.nome} (${p.capim || 'N/I'}) ${emoji} ${status} ${fonte} ‚Ä¢ ${diasDescanso}/${diasIdeais} dias</option>`;
                    });
                    
                    // Se o lote j√° tem um piquete (mesmo que ocupado), adicionar como op√ß√£o
                    if (lote.piquete_atual_id && !data.find(p => p.id == lote.piquete_atual_id)) {
                        // Buscar info do piquete atual
                        fetch('/api/piquetes/' + lote.piquete_atual_id)
                            .then(r => r.json())
                            .then(p => {
                                const temReal = p.altura_real_medida !== null && p.altura_real_medida !== undefined;
                                const alturaUsada = temReal ? p.altura_real_medida : p.altura_estimada;
                                const fonte = temReal ? '[MEDIDA]' : '[ESTIMADA]';
                                
                                const emoji = p.bloqueado ? 'üî¥' : (alturaUsada >= p.altura_entrada ? 'üü¢' : 'üü°');
                                const status = p.bloqueado ? 'BLOQUEADO' : (alturaUsada >= p.altura_entrada ? 'APTO' : 'RECUPERANDO');
                                const isRecuperando = !p.bloqueado && alturaUsada < p.altura_entrada;
                                const dangerClass = isRecuperando ? 'background:#f8d7da;' : '';
                                html += `<option value="${p.id}" selected style="${dangerClass}">‚ö†Ô∏è ${p.nome} (${p.capim || 'N/I'}) ${emoji} ${status} ${fonte} (ATUAL)</option>`;
                                select.innerHTML = html;
                                
                                // Mostrar aviso se est√° em recupera√ß√£o
                                if (isRecuperando) {
                                    document.getElementById('aviso-piquete-recuperacao').style.display = 'block';
                                }
                            });
                    } else {
                        select.innerHTML = html;
                    }
                    
                    // Verificar se o piquete atual est√° em recupera√ß√£o
                    if (lote.piquete_atual_id && data.find(p => p.id == lote.piquete_atual_id)) {
                        const piqueteAtual = data.find(p => p.id == lote.piquete_atual_id);
                        const temReal = piqueteAtual.altura_real_medida !== null && piqueteAtual.altura_real_medida !== undefined;
                        const alturaUsada = temReal ? piqueteAtual.altura_real_medida : piqueteAtual.altura_estimada;
                        if (alturaUsada && alturaUsada < piqueteAtual.altura_entrada) {
                            document.getElementById('aviso-piquete-recuperacao').style.display = 'block';
                        }
                    }
                });
            
            document.getElementById('modal-editar').classList.add('active');
        }
        
        function verificarPiqueteRecuperacao() {
            const select = document.getElementById('edit-lote-piquete');
            const piqueteId = select.value;
            
            if (!piqueteId) {
                document.getElementById('aviso-piquete-recuperacao').style.display = 'none';
                return;
            }
            
            // Buscar info do piquete
            fetch('/api/piquetes/' + piqueteId)
                .then(r => r.json())
                .then(p => {
                    const emRecuperacao = p.altura_atual && p.altura_atual < p.altura_entrada && !p.bloqueado;
                    document.getElementById('aviso-piquete-recuperacao').style.display = emRecuperacao ? 'block' : 'none';
                });
        }
        
        function limparPiqueteEdicao() {
            document.getElementById('edit-lote-piquete').value = '';
            document.getElementById('aviso-piquete-recuperacao').style.display = 'none';
        }
        
        function abrirModalDetalhes(loteId) {
            const lote = lotes.find(l => l.id === loteId);
            if (!lote) return;
            
            // Calcular peso total
            const pesoTotal = (lote.quantidade || 0) * (lote.peso_medio || 0);
            const ua = pesoTotal / 450; // 1 UA = 450kg
            
            // Calcular consumo estimado
            let consumoEstimado = '-';
            let consumoInfo = '';
            if (lote.quantidade && lote.peso_medio && lote.piquete_area) {
                const uaHa = ua / (lote.piquete_area || 1);
                const fatorCategoria = {
                    'Bezerro(a)': 0.6,
                    'Garrote / Novilho(a)': 0.8,
                    'Boi Magro / Engorda': 1.0,
                    'Vaca': 1.0,
                    'Touro': 1.3,
                    'Personalizado': null
                };
                
                // Usar consumo_base do lote se personalizado
                const consumoBase = lote.consumo_base || 0.8; // padr√£o
                const fator = fatorCategoria[lote.categoria] || 1.0;
                const fatorUsado = (lote.categoria === 'Personalizado') ? 1.0 : fator;
                const consumoCmDia = consumoBase * (uaHa / 2) * fatorUsado;
                
                consumoEstimado = consumoCmDia.toFixed(2) + ' cm/dia';
                consumoInfo = `
                    <div style="background: #e8f5e9; padding: 8px; border-radius: 6px; margin-top: 8px; font-size: 0.8rem;">
                        <strong style="color: #2e7d32;">üìä Detalhamento T√©cnico</strong><br>
                        UA/ha: ${uaHa.toFixed(2)}<br>
                        ${lote.categoria === 'Personalizado' 
                            ? `Consumo base customizado: ${consumoBase} cm/dia`
                            : `Fator categoria: ${(fator * 100).toFixed(0)}%`}
                    </div>
                `;
            }
            
            // Status do lote - usar status_info (calculado) em vez de status_calculado (cache)
            let statusTexto = '';
            let statusCor = '';
            const statusCalc = lote.status_info ? lote.status_info.status : (lote.status_calculado || '');
            
            if (!lote.piquete_atual_id) {
                statusTexto = 'üîµ Aguardando Aloca√ß√£o';
                statusCor = '#004085';
            } else {
                switch(statusCalc) {
                    case 'RETIRAR':
                        statusTexto = 'üî¥ Precisa Sair';
                        statusCor = '#721c24';
                        break;
                    case 'ATENCAO':
                        statusTexto = 'üü† Aten√ß√£o';
                        statusCor = '#856404';
                        break;
                    default:
                        statusTexto = 'üü¢ OK';
                        statusCor = '#155724';
                }
            }
            
            // Dias T√©cnicos
            let diasInfo = '';
            if (lote.piquete_atual_id && lote.dias_tecnicos) {
                const diasPassados = calcularDiasPassados(lote.data_entrada);
                const dataFormatada = formatarData(lote.data_entrada);
                const diasRestantes = Math.max(0, (lote.dias_tecnicos || 0) - diasPassados);
                
                diasInfo = `
                    <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; margin-bottom: 15px;">
                        <strong style="color: #495057;">üìÖ Dias T√©cnicos</strong>
                        <div style="font-size: 1.5rem; color: #28a745;">
                            ${lote.dias_tecnicos} dias
                        </div>
                        ${dataFormatada 
                            ? `<div style="margin-top: 8px; padding: 8px; background: #e3f2fd; border-radius: 6px;">
                                <strong style="color: #0d6efd;">üìå Data de Entrada:</strong> ${dataFormatada}
                               </div>`
                            : ''}
                        ${diasPassados !== null 
                            ? `<div style="margin-top: 8px; padding: 8px; background: #fff3cd; border-radius: 6px;">
                                <strong style="color: #856404;">‚è±Ô∏è Decorridos:</strong> ${diasPassados} dia(s)
                               </div>`
                            : ''}
                        ${lote.data_saida_prevista 
                            ? `<div style="margin-top: 8px; padding: 8px; background: #d4edda; border-radius: 6px;">
                                <strong style="color: #155724;">üìÖ Sa√≠da Prevista:</strong> ${lote.data_saida_prevista}
                               </div>`
                            : ''}
                        ${diasRestantes > 0 
                            ? `<div style="margin-top: 8px; padding: 8px; background: #d1ecf1; border-radius: 6px;">
                                <strong style="color: #0c5460;">üìä Restantes:</strong> ${diasRestantes} dias
                               </div>`
                            : ''}
                    </div>
                `;
            }
            
            const html = `
                <div style="text-align: center; margin-bottom: 20px;">
                    <h2 style="color: #007bff; margin-bottom: 5px;">${lote.nome}</h2>
                    <span style="background: ${statusCor}; color: white; padding: 5px 15px; border-radius: 20px; font-size: 0.9rem;">
                        ${statusTexto}
                    </span>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 20px;">
                    <div style="background: #e3f2fd; padding: 15px; border-radius: 10px; text-align: center;">
                        <div style="font-size: 1.6rem; color: #007bff; font-weight: bold;">${lote.quantidade || 0}</div>
                        <small style="color: #495057;">üêÑ Animais</small>
                    </div>
                    <div style="background: #fff3cd; padding: 15px; border-radius: 10px; text-align: center;">
                        <div style="font-size: 1.6rem; color: #856404; font-weight: bold;">${ua.toFixed(2)}</div>
                        <small style="color: #495057;">üìè UA Total</small>
                    </div>
                    <div style="background: #28a745; color: white; padding: 15px; border-radius: 10px; text-align: center;">
                        <div style="font-size: 1.6rem; font-weight: bold;">${consumoEstimado}</div>
                        <small style="color: rgba(255,255,255,0.9);">üìâ Consumo Est.</small>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 20px;">
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; text-align: center;">
                        <div style="font-size: 1.4rem; color: #495057; font-weight: bold;">${(lote.peso_medio || 0).toFixed(0)} kg</div>
                        <small style="color: #6c757d;">‚öñÔ∏è Peso M√©dio</small>
                    </div>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; text-align: center;">
                        <div style="font-size: 1.4rem; color: #495057; font-weight: bold;">${pesoTotal.toFixed(0)} kg</div>
                        <small style="color: #6c757d;">üèãÔ∏è Peso Total</small>
                        <div style="font-size: 0.7rem; color: #999; margin-top: 5px;">üìä Estimado (m√©dia √ó qtd)</div>
                    </div>
                </div>
                
                ${consumoInfo}
                
                ${diasInfo}
                
                <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                    <strong style="color: #495057;">üìÅ Categoria:</strong> ${lote.categoria || 'N√£o informada'}<br>
                    ${lote.consumo_base ? `<strong style="color: #495057;">‚öôÔ∏è Consumo Base:</strong> ${lote.consumo_base} cm/dia<br>` : ''}
                    <strong style="color: #495057;">üìç Piquete Atual:</strong> ${lote.piquete_nome || 'Sem piquete'}<br>
                    ${lote.capim ? `<strong style="color: #495057;">üåø Capim:</strong> ${lote.capim}<br>` : ''}
                    ${lote.piquete_area ? `<strong style="color: #495057;">üìê √Årea do Piquete:</strong> ${lote.piquete_area} ha` : ''}
                </div>
                
                ${lote.created_at ? `
                    <div style="text-align: center; font-size: 0.85rem; color: #6c757d;">
                        üìÖ Criado em: ${new Date(lote.created_at).toLocaleDateString('pt-BR')}
                    </div>
                ` : ''}
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px;">
                    <button class="btn btn-primary" onclick="fecharModal('modal-detalhes'); abrirModalEditar(${lote.id});">‚úèÔ∏è Editar Lote</button>
                    ${lote.piquete_atual_id ? `<button class="btn btn-warning" onclick="fecharModal('modal-detalhes'); registrarSaida(${lote.id});">üì§ Registrar Sa√≠da</button>` : `<button class="btn btn-success" onclick="fecharModal('modal-detalhes'); abrirModalMover(${lote.id}, '${lote.nome}');">‚û°Ô∏è Mover para Piquete</button>`}
                </div>
            `;
            
            document.getElementById('detalhes-lote-conteudo').innerHTML = html;
            document.getElementById('modal-detalhes').classList.add('active');
        }
        
        function salvarEdicaoLote() {
            const id = document.getElementById('edit-lote-id').value;
            const nome = document.getElementById('edit-lote-nome').value;
            const piqueteId = document.getElementById('edit-lote-piquete').value || null;
            
            if (!nome) return alert('Digite o nome do lote!');
            
            const categoria = document.getElementById('edit-lote-categoria').value;
            let peso_medio = parseFloat(document.getElementById('edit-lote-peso').value) || 0;
            
            // Se personalizado, usar par√¢metros do modal
            let consumo_base = null;
            if (categoria === 'Personalizado') {
                if (!window.personalizadoParamsEdit) {
                    return alert('Por favor, configure os par√¢metros t√©cnicos do Personalizado!');
                }
                peso_medio = window.personalizadoParamsEdit.peso_medio;
                consumo_base = window.personalizadoParamsEdit.consumo_base;
            }
            
            const payload = {
                nome: nome,
                categoria: categoria,
                quantidade: parseInt(document.getElementById('edit-lote-quantidade').value) || 1,
                peso_medio: peso_medio,
                piquete_atual_id: piqueteId
            };
            
            // Adicionar consumo_base se personalizado
            if (consumo_base !== null) {
                payload.consumo_base = consumo_base;
            }
            
            fetch(`/api/lotes/${id}`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            }).then(r => r.json())
              .then(data => {
                  if (data.status === 'ok') {
                      fecharModal('modal-editar');
                      carregarLotes();
                      alert('Lote atualizado!');
                  }
              });
        }
        
        function excluirLote() {
            const id = document.getElementById('edit-lote-id').value;
            const nome = document.getElementById('edit-lote-nome').value;
            
            if (!confirm(`Tem certeza que deseja excluir o lote "${nome}"?`)) return;
            
            fetch(`/api/lotes/${id}`, {method: 'DELETE'})
                .then(r => r.json())
                .then(data => {
                    if (data.status === 'ok') {
                        fecharModal('modal-editar');
                        carregarLotes();
                        alert('Lote exclu√≠do!');
                    }
                });
        }
        
        function atualizarStatus() {
            fetch(`/api/lotes/atualizar-status?fazenda_id=${fazendaId}`, {method: 'POST'})
                .then(r => r.json())
                .then(data => {
                    if (data.status === 'ok') {
                        carregarLotes();
                        alert('Status atualizados!');
                    }
                });
        }
        
        function abrirModalTodosPiquetes(loteId) {
            const lote = lotes.find(l => l.id === loteId);
            if (!lote) return;
            
            document.getElementById('mover-lote-id').value = lote.id;
            document.getElementById('mover-lote-nome').textContent = lote.nome;
            document.getElementById('modal-todos-piquetes').classList.add('active');
            
            // Carregar todos os piquetes dispon√≠veis
            fetch(`/api/lotes/${loteId}/sugerir-piquetes?fazenda_id=${fazendaId}`)
                .then(r => r.json())
                .then(data => {
                    const container = document.getElementById('lista-todos-piquetes');
                    
                    if (data.length === 0) {
                        container.innerHTML = '<p style="text-align: center; color: #999;">Nenhum piquete dispon√≠vel</p>';
                        return;
                    }
                    
                    container.innerHTML = data.map((p, i) => {
                        const isApto = p.status === 'APTO' || p.status === 'APTO_ALCANCADA';
                        const emoji = isApto ? 'üü¢' : 'üü°';
                        const statusText = isApto ? 'APTO' : 'RECUPERANDO';
                        const diasDescanso = p.dias_descanso || 0;
                        const diasIdeais = p.dias_ideais || 30;
                        
                        if (isApto) {
                            // Piquete apto - pronto para receber
                            return `
                                <div class="sugestao-item apto" onclick="selecionarPiquete(${p.id}, this)">
                                    <div class="sugestao-header">
                                        <span class="sugestao-nome">${p.nome}</span>
                                        <span class="sugestao-badge badge-apto">üü¢ APTO</span>
                                    </div>
                                    <div class="sugestao-info">
                                        üåø ${p.capim || 'N/I'} ‚Ä¢ üìê ${p.area || 0} ha
                                        <br>‚è±Ô∏è ${diasDescanso}/${diasIdeais} dias descansando
                                    </div>
                                </div>
                            `;
                        } else {
                            // Piquete em recupera√ß√£o
                            const alturaAtual = p.altura_atual || 0;
                            const alturaMin = p.altura_entrada || 25;
                            return `
                                <div class="sugestao-item quase" onclick="selecionarPiquete(${p.id}, this)">
                                    <div class="sugestao-header">
                                        <span class="sugestao-nome">${p.nome}</span>
                                        <span class="sugestao-badge badge-quase">üü° RECUPERANDO</span>
                                    </div>
                                    <div class="sugestao-info">
                                        üåø ${p.capim || 'N/I'} ‚Ä¢ üìê ${p.area || 0} ha
                                        <br>üìè ${alturaAtual}/${alturaMin} cm
                                        <br>‚è±Ô∏è ${diasDescanso}/${diasIdeais} dias descansando
                                    </div>
                                </div>
                            `;
                        }
                    }).join('');
                });
        }
        
        function fecharModal(id) {
            document.getElementById(id).classList.remove('active');
        }
    </script>
</body>
</html>
