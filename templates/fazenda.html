<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ fazenda.nome }} - PastoFlow</title>
    <link rel="icon" type="image/x-icon" href="/static/icon/PastoFlow-logo.ico">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: system-ui, sans-serif; background: #f0f2f5; display: flex; min-height: 100vh; }
        
        /* Sidebar */
        .sidebar {
            width: 260px;
            background: linear-gradient(180deg, #1a1a2e 0%, #16213e 100%);
            color: white;
            padding: 20px 0;
            flex-shrink: 0;
        }
        .sidebar-header {
            padding: 0 20px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            margin-bottom: 20px;
            text-align: center;
        }
        .sidebar-header h1 { font-size: 1.2rem; margin-bottom: 5px; }
        .sidebar-header span { font-size: 0.9rem; opacity: 0.9; font-weight: 500; display: block; margin-top: 5px; }
        .data-teste {
            background: rgba(255, 193, 7, 0.2);
            border: 1px solid rgba(255, 193, 7, 0.5);
            border-radius: 6px;
            padding: 8px 12px;
            margin-top: 10px;
            font-size: 0.8rem;
        }
        .data-teste.modo-real {
            background: rgba(40, 167, 69, 0.2);
            border-color: rgba(40, 167, 69, 0.5);
        }
        .data-teste-label { opacity: 0.7; font-size: 0.75rem; }
        .data-teste-valor { color: #00d9ff; font-weight: bold; font-size: 0.9rem; }
        .data-teste.modo-real .data-teste-valor { color: #28a745; }
        .menu { list-style: none; }
        .menu-item {
            padding: 15px 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.3s;
            border-left: 3px solid transparent;
        }
        .menu-item:hover { background: rgba(255,255,255,0.05); }
        .menu-item.active {
            background: rgba(0, 217, 255, 0.1);
            border-left-color: #00d9ff;
        }
        .menu-item span { font-size: 1.1rem; }
        
        /* Main Content */
        .main { flex: 1; display: flex; flex-direction: column; }
        
        /* Header */
        .header {
            background: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .header h2 { color: #1a1a2e; font-size: 1.3rem; }
        .user-info { display: flex; align-items: center; gap: 15px; }
        .user-info a { color: #00d9ff; text-decoration: none; }
        
        /* Content */
        .content { padding: 25px; flex: 1; overflow-y: auto; }
        
        /* Dashboard Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 3px 15px rgba(0,0,0,0.05);
        }
        .stat-card h4 { color: #666; font-size: 0.85rem; margin-bottom: 10px; }
        .stat-card strong { display: block; font-size: 2rem; color: #00d9ff; }
        .stat-card p { color: #999; font-size: 0.8rem; margin-top: 5px; }
        
        /* Cards */
        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 3px 15px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }
        .card h3 { color: #1a1a2e; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        
        /* Grid for dashboard */
        .dashboard-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        
        /* Piquetes Section */
        #piquetes-section { display: none; }
        #piquetes-section.active { display: block; }
        
        /* Map Container */
        #map-container { height: 450px; border-radius: 10px; overflow: hidden; }
        #map { height: 100%; }
        
        /* Piquetes List */
        .piquetes-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; margin-top: 20px; }
        .piquete-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            border-left: 4px solid #6c757d; /* Neutro por padr√£o */
        }
        .piquete-card.ocupado { border-left-color: #dc3545; background: #fff5f5; }
        .piquete-card.recuperando { border-left-color: #fd7e14; background: #fff8f0; }
        .piquete-card.disponivel { border-left-color: #28a745; background: #f0fff4; }
        .piquete-card.sem-altura { border-left-color: #ffc107; background: #fffdf0; }
        .piquete-card h4 { color: #1a1a2e; margin-bottom: 8px; }
        .piquete-card p { color: #666; font-size: 0.85rem; margin-bottom: 5px; }
        .badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 15px;
            font-size: 0.75rem;
            font-weight: bold;
        }
        .badge-green { background: #d4edda; color: #155724; }
        .badge-red { background: #f8d7da; color: #721c24; }
        .badge-yellow { background: #fff3cd; color: #856404; }
        .badge-orange { background: #ffe5d0; color: #c45a00; } /* RECUPERANDO */
        .badge-blue { background: #cce5ff; color: #004085; }
        
        /* Buttons */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s;
        }
        .btn-primary { background: #00d9ff; color: #1a1a2e; }
        .btn-primary:hover { background: #00c4e6; }
        .btn-success { background: #28a745; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        
        /* Form */
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; color: #666; font-size: 0.85rem; margin-bottom: 5px; }
        .form-group input, .form-group select {
            width: 100%;
            padding: 10px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 0.95rem;
        }
        .form-group input:focus { outline: none; border-color: #00d9ff; }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            width: 500px;
            max-width: 90%;
        }
        .modal-header { display: flex; justify-content: space-between; margin-bottom: 20px; }
        .modal-header h3 { color: #1a1a2e; }
        .modal-close { background: none; border: none; font-size: 1.5rem; cursor: pointer; }
        
        /* Table */
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th, .data-table td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        .data-table th { color: #666; font-weight: 500; font-size: 0.85rem; }
        .data-table tr:hover { background: #f8f9fa; }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
            <img src="/static/icon/PastoFlow-logo.png" alt="PastoFlow" style="width: 120px; margin-bottom: 10px;">
            <span>{{ fazenda.nome }}</span>
            <div id="data-teste-display" class="data-teste modo-real">
                <div class="data-teste-label">Data do Sistema</div>
                <div class="data-teste-valor" id="data-teste-valor">Carregando...</div>
            </div>
        </div>
        <ul class="menu">
            <li class="menu-item active" onclick="showSection('dashboard')">
                <span>üìä</span> Dashboard
            </li>
            <li class="menu-item" onclick="showSection('piquetes')">
                <span>üìç</span> Piquetes
            </li>
            <li class="menu-item" onclick="window.location.href='/fazenda/' + fazendaId + '/lotes'">
                <span>üìã</span> Lotes
            </li>
            <li class="menu-item" onclick="showSection('movimentacao')">
                <span>üîÑ</span> Movimenta√ß√£o
            </li>
            <li class="menu-item" onclick="window.location.href='/fazenda/' + fazendaId + '/rotacao'">
                <span>üß†</span> IA Rota√ß√£o
            </li>
            <li class="menu-item" onclick="showSection('relatorios')">
                <span>üìà</span> Relat√≥rios
            </li>
        </ul>
    </div>
    
    <!-- Main -->
    <div class="main">
        <div class="header">
            <h2>üè† {{ fazenda.nome }}</h2>
            <div class="user-info">
                <button class="btn" style="background: #6c757d; color: white; padding: 8px 15px; margin-right: 10px;" onclick="verificarAlertasManualmente()" title="Verificar alertas">
                    üîÑ
                </button>
                <button class="btn" style="background: transparent; color: #1a1a2e; padding: 8px 15px; position: relative;" onclick="abrirModalAlertas()" title="Alertas">
                    üîî
                    <span id="alerta-badge" style="display: none; position: absolute; top: 0; right: 0; background: #dc3545; color: white; border-radius: 50%; padding: 2px 6px; font-size: 0.7rem;">0</span>
                </button>
                <a href="{{ url_for('home') }}" style="margin-left: 15px;">‚Üê Voltar</a>
                <a href="{{ url_for('logout') }}" class="btn btn-danger" style="margin-left: 10px;">Sair</a>
            </div>
        </div>
        
        <div class="content">
            <!-- DASHBOARD -->
            <div id="dashboard-section">
                <div class="stats-grid">
                    <div class="stat-card">
                        <h4>Total de Piquetes</h4>
                        <strong>{{ stats.piquetes or 0 }}</strong>
                        <p>piquetes cadastrados</p>
                    </div>
                    <div class="stat-card">
                        <h4>√Årea Total</h4>
                        <strong>{{ stats.area_total or 0 }}</strong>
                        <p>hectares</p>
                    </div>
                    <div class="stat-card">
                        <h4>Animais</h4>
                        <strong>{{ stats.animais or 0 }}</strong>
                        <p>bois cadastrados</p>
                    </div>
                    <div class="stat-card">
                        <h4>Dispon√≠veis</h4>
                        <strong>{{ stats.disponiveis or 0 }}</strong>
                        <p>piquetes vagos</p>
                    </div>
                </div>
                
                <div class="dashboard-grid">
                    <div class="card">
                        <h3>üìç Mapa dos Piquetes</h3>
                        <div id="map-container">
                            <div id="map"></div>
                        </div>
                        <div style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                            <button class="btn btn-primary" onclick="geoLocalizacaoDashboard()">üìç Minha Localiza√ß√£o</button>
                            <div style="flex: 1; display: flex; gap: 5px; min-width: 250px;">
                                <input type="text" id="endereco-dashboard" placeholder="Buscar endere√ßo (Ex: Aruan√£, GO)" style="flex: 1; padding: 10px; border: 2px solid #ddd; border-radius: 8px;">
                                <button class="btn btn-success" onclick="buscarEnderecoDashboard()">üîç Buscar</button>
                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <h3>üìã √öltimas Movimenta√ß√µes</h3>
                        <table class="data-table">
                            <thead>
                                <tr><th>Animal</th><th>De</th><th>Para</th><th>Data</th></tr>
                            </thead>
                            <tbody id="ultimas-mov"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- PIQUETES -->
            {% include 'piquetes.html' %}
            
            <!-- MOVIMENTA√á√ÉO -->
            <div id="movimentacao-section" style="display:none;">
                <div class="card">
                    <h3>üîÑ Nova Movimenta√ß√£o</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label>Animal/Lote</label>
                            <select id="mov-animal"><option value="">Selecione...</option></select>
                        </div>
                        <div class="form-group">
                            <label>Origem (De)</label>
                            <select id="mov-origem"><option value="">Nenhum</option></select>
                        </div>
                        <div class="form-group">
                            <label>Destino (Para)</label>
                            <select id="mov-destino"><option value="">Selecione...</option></select>
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="novaMovimentacao()">üîÑ Movimentar</button>
                </div>
                
                <div class="card">
                    <h3>üìã Hist√≥rico de Movimenta√ß√µes</h3>
                    <table class="data-table">
                        <thead>
                            <tr><th>Data</th><th>Animal</th><th>Origem</th><th>Destino</th><th>Motivo</th></tr>
                        </thead>
                        <tbody id="historico-mov"></tbody>
                    </table>
                </div>
            </div>
            
            <!-- RELAT√ìRIOS -->
            <div id="relatorios-section" style="display:none;">
                <div class="card">
                    <h3>üìà Relat√≥rios da Fazenda</h3>
                    <p style="color: #666;">Em breve...</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal Novo Lote -->
    <div class="modal" id="modal-lote">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üêÑ Novo Lote</h3>
                <button class="modal-close" onclick="fecharModalLote()">√ó</button>
            </div>
            <div class="form-group">
                <label>Nome/Identifica√ß√£o</label>
                <input type="text" id="lote-nome" placeholder="Ex: Lote 01 - Nelore">
            </div>
            <div class="form-group">
                <label>Quantidade</label>
                <input type="number" id="lote-qtd" value="1" min="1">
            </div>
            <div class="form-group">
                <label>Categoria</label>
                <select id="lote-cat">
                    <option value="Bovino">Bovino</option>
                    <option value="Equino">Equino</option>
                    <option value="Ovino">Ovino</option>
                </select>
            </div>
            <div class="form-group">
                <label>Peso M√©dio (kg)</label>
                <input type="number" id="lote-peso" value="0" step="0.1">
            </div>
            <button class="btn btn-success" style="width: 100%;" onclick="salvarLote()">‚ûï Adicionar Lote</button>
        </div>
    </div>
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const fazendaId = {{ fazenda.id }};
        // Coordenadas da sede da fazenda (do banco de dados)
        const fazendaLat = {{ fazenda.latitude_sede if fazenda.latitude_sede else '-15.7942' }};
        const fazendaLng = {{ fazenda.longitude_sede if fazenda.longitude_sede else '-47.8822' }};
        // Fallback se null
        const defaultLat = -15.7942;
        const defaultLng = -47.8822;
        const mapaLat = fazendaLat || defaultLat;
        const mapaLng = fazendaLng || defaultLng;
        
        let map, mapDesenho, layerGroup;
        let pontos = [];
        let piquetes = [];
        let animais = [];
        
        // Menu
        let mapPiquetes = null;
        let mapPiquetesLat = {{ fazenda.latitude_sede if fazenda.latitude_sede else '-15.7942' }};
        let mapPiquetesLng = {{ fazenda.longitude_sede if fazenda.longitude_sede else '-47.8822' }};
        let mapDesenhoInit = false;
        function showSection(id) {
            document.querySelectorAll('.menu-item').forEach(i => i.classList.remove('active'));
            event.target.closest('.menu-item').classList.add('active');
            document.querySelectorAll('[id$="-section"]').forEach(s => s.style.display = 'none');
            document.getElementById(id + '-section').style.display = 'block';
            
            if (id === 'piquetes') {
                setTimeout(() => {
                    if (!mapPiquetes) {
                        mapPiquetes = L.map('map-piquetes').setView([mapaLat, mapaLng], 15);
                        L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {attribution: 'Esri'}).addTo(mapPiquetes);
                    }
                    mapPiquetes.invalidateSize();
                    drawAllPiquetes();  // Desenhar os pol√≠gonos
                }, 200);
            }
        }
        
        // Maps
        function initMap() {
            // Mapa do dashboard - centralizado na sede da fazenda
            map = L.map('map').setView([mapaLat, mapaLng], 14);
            L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {attribution: 'Esri'}).addTo(map);
            
            // Adicionar marcador da sede da fazenda se tiver coordenadas
            {% if fazenda.latitude_sede and fazenda.longitude_sede %}
            L.marker([mapaLat, mapaLng], {
                icon: L.divIcon({
                    className: 'fazenda-marker',
                    html: 'üè†',
                    iconSize: [30, 30],
                    iconAnchor: [15, 30]
                })
            }).addTo(map).bindPopup('<strong>{{ fazenda.nome }}</strong><br>Sede da fazenda').openPopup();
            {% endif %}
            
            // Mapa da aba Piquetes (s√≥ inicializa, dados carregados depois)
        }
        
        function initMapPiquetes() {
            // Inicializar mapa da aba Piquetes centralizado na sede da fazenda
            if (!mapPiquetes) {
                mapPiquetes = L.map('map-piquetes').setView([mapaLat, mapaLng], 15);
                L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {attribution: 'Esri'}).addTo(mapPiquetes);
                
                // Adicionar marcador da sede da fazenda se tiver coordenadas
                {% if fazenda.latitude_sede and fazenda.longitude_sede %}
                L.marker([mapaLat, mapaLng], {
                    icon: L.divIcon({
                        className: 'fazenda-marker',
                        html: 'üè†',
                        iconSize: [30, 30],
                        iconAnchor: [15, 30]
                    })
                }).addTo(mapPiquetes).bindPopup('<strong>{{ fazenda.nome }}</strong><br>Sede da fazenda');
                {% endif %}
            }
            mapPiquetes.invalidateSize();
        }
        
        function drawAllPiquetesOnMap() {
            if (!map) return;
            
            // Limpar pol√≠gonos E labels dos piquetes
            map.eachLayer(function(layer) {
                if (layer instanceof L.Polygon || (layer instanceof L.Marker && layer.options?.icon?.options?.className === 'piquete-label')) {
                    map.removeLayer(layer);
                }
            });
            
            piquetes.forEach(p => {
                if (p.geometria) {
                    try {
                        const geo = JSON.parse(p.geometria);
                        if (geo.type === 'Polygon' && geo.coordinates && geo.coordinates.length > 0) {
                            const coords = geo.coordinates[0].map(c => [c[1], c[0]]); // lng,lat -> lat,lng
                            
                            // Determinar cor baseada no estado E ALTURA ESTIMADA
                            let corPoligono = '#28a745'; // verde = dispon√≠vel
                            const temReal = p.altura_real_medida !== null && p.altura_real_medida !== undefined;
                            const temAlgumaAltura = temReal || (p.altura_estimada !== null && p.altura_estimada !== undefined);
                            const fonteAlt = p.fonte_altura || 'estimada';
                            
                            if (!temAlgumaAltura) {
                                corPoligono = '#fd7e14'; // laranja = aguardando altura
                            } else if (p.estado === 'ocupado') {
                                corPoligono = '#dc3545'; // vermelho = ocupado
                            } else if (p.altura_estimada >= p.altura_entrada) {
                                corPoligono = '#28a745'; // verde = dispon√≠vel (baseado na estimativa)
                            } else if (temReal && p.altura_real_medida >= p.altura_entrada) {
                                corPoligono = '#28a745'; // verde = dispon√≠vel (baseado na medi√ß√£o)
                            } else {
                                corPoligono = '#ffc107'; // amarelo = recuperando
                            }
                            
                            // Animais no piquete
                            const animaisInfo = p.animais_no_piquete > 0 
                                ? `<br><strong style="color:#007bff;">üêÑ ${p.animais_no_piquete} animal(is)</strong>` 
                                : '';
                            
                            // Badge de fonte
                            const badgeFonte = fonteAlt === 'real'
                                ? '<br><span style="background:#28a745;color:white;padding:2px 6px;border-radius:8px;font-size:0.75rem;">üìè MEDIDA</span>'
                                : '<br><span style="background:#fd7e14;color:white;padding:2px 6px;border-radius:8px;font-size:0.75rem;">üìê ESTIMADA</span>';
                            
                            // Dias de descanso - MAPA DASHBOARD
                            let diasInfo = '';
                            if (!temAlgumaAltura) {
                                diasInfo = `<br>‚ö†Ô∏è Aguardando altura`;
                            } else if (p.estado === 'ocupado') {
                                diasInfo = `<br>üìä ${p.dias_tecnicos || 0} dias t√©cnicos${badgeFonte}`;
                                if (p.altura_estimada) {
                                    diasInfo += `<br>üìè Altura: ${p.altura_estimada}/${p.altura_entrada || '?'} cm`;
                                }
                            } else if (p.altura_estimada >= p.altura_entrada) {
                                diasInfo = `<br>üü¢ APTO para entrada${badgeFonte}`;
                                if (p.altura_estimada) {
                                    diasInfo += `<br>üìè Altura: ${p.altura_estimada} cm`;
                                }
                            } else {
                                const diasDescanso = p.dias_descanso || 0;
                                const diasMin = p.dias_descanso_min || 30;
                                const faltam = Math.max(0, diasMin - diasDescanso);
                                diasInfo = `<br>üîÑ ${diasDescanso}/${diasMin} dias (falta ${faltam})${badgeFonte}`;
                                if (p.altura_estimada) {
                                    diasInfo += `<br>üìè Altura: ${p.altura_estimada}/${p.altura_entrada || '?'} cm`;
                                }
                            }
                            
                            // Aviso urgente se animais em piquete em recupera√ß√£o
                            const avisoUrgente = (p.animais_no_piquete > 0 && p.altura_estimada && p.altura_estimada < p.altura_entrada)
                                ? `<br><strong style="color:#dc3545;">üö® AVISO: Remova urgentemente!</strong>`
                                : '';
                            
                            // Draw polygon
                            const polygon = L.polygon(coords, {
                                color: corPoligono,
                                weight: 3,
                                fill: true,
                                fillOpacity: 0.4
                            }).addTo(map).bindPopup(`
                                <strong style="font-size:14px;">${p.nome}</strong><br>
                                <strong>üåø ${p.capim || 'N/I'}</strong>${animaisInfo}<br>
                                üìê ${p.area || 0} hectares<br>
                                üìè ${p.altura_estimada || '?'}/${p.altura_entrada || '?'} cm${badgeFonte}${diasInfo}${avisoUrgente}
                            `);
                            
                            // Add label in center of polygon
                            if (coords.length > 0) {
                                let latSum = 0, lngSum = 0;
                                coords.forEach(c => { latSum += c[0]; lngSum += c[1]; });
                                const centerLat = latSum / coords.length;
                                const centerLng = lngSum / coords.length;
                                
                                const label = L.divIcon({
                                    className: 'piquete-label',
                                    html: `<div style="background:rgba(255,255,255,0.9);padding:2px 6px;border-radius:4px;font-size:11px;font-weight:bold;color:#1a1a2e;text-shadow:1px 1px 0 #fff;box-shadow:0 1px 3px rgba(0,0,0,0.2);">${p.nome}</div>`,
                                    iconSize: [80, 20],
                                    iconAnchor: [40, 10]
                                });
                                L.marker([centerLat, centerLng], {icon: label}).addTo(map);
                            }
                        }
                    } catch (e) {
                        console.log('Erro ao desenhar poligono', p.id);
                    }
                }
            });
        }
        
        function initMapDesenho() {
            if (mapDesenhoInit) {
                // Limpar layer anterior e redesenhar todos os pol√≠gonos
                layerGroup.clearLayers();
                drawPiquetesExistentes();
                setTimeout(() => mapDesenho.invalidateSize(), 200);
                return;
            }
            // Usar coordenadas da fazenda como ponto inicial do desenho
            mapDesenho = L.map('map-desenho').setView([mapaLat, mapaLng], 15);
            L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {attribution: 'Esri'}).addTo(mapDesenho);
            layerGroup = L.layerGroup().addTo(mapDesenho);
            
            drawPiquetesExistentes();
            
            mapDesenho.on('click', function(e) {
                pontos.push([e.latlng.lat, e.latlng.lng]);
                atualizarDesenho();
            });
            mapDesenhoInit = true;
            setTimeout(() => mapDesenho.invalidateSize(), 200);
        }
        
        function drawPiquetesExistentes() {
            // Desenhar pol√≠gonos existentes
            piquetes.forEach(p => {
                if (p.geometria) {
                    try {
                        const geo = JSON.parse(p.geometria);
                        if (geo.type === 'Polygon' && geo.coordinates && geo.coordinates.length > 0) {
                            const coords = geo.coordinates[0].map(c => [c[1], c[0]]);
                            L.polygon(coords, {
                                color: '#666',
                                weight: 2,
                                fill: true,
                                fillOpacity: 0.2
                            }).addTo(layerGroup).bindPopup(`${p.nome} (existente)`);
                        }
                    } catch (e) {}
                }
            });
        }
        
        function atualizarDesenho() {
            layerGroup.clearLayers();
            pontos.forEach((p, i) => {
                L.circleMarker([p[0], p[1]], {color: 'red', fillColor: 'red', fillOpacity: 1, radius: 6}).addTo(layerGroup);
            });
            if (pontos.length >= 2) {
                L.polyline(pontos, {color: 'red', weight: 2}).addTo(layerGroup);
            }
            if (pontos.length >= 3) {
                L.polygon(pontos, {color: '#228B22', weight: 3, fill: true, fillOpacity: 0.3}).addTo(layerGroup);
                const area = calcularAreaPolygon(pontos);
                document.getElementById('pq-area').value = area.toFixed(2);
                // Travar √°rea quando desenhado no mapa
                document.getElementById('pq-area').setAttribute('readonly', true);
                document.getElementById('pq-area').style.background = '#f5f5f5';
            } else {
                document.getElementById('pq-area').value = '0';
            }
        }
        
        function calcularAreaPolygon(coords) {
            // F√≥rmula de Shoelace para calcular √°rea
            // 1 grau lat ‚âà 111.32 km na linha do equador
            // 1 grau lng ‚âà 111.32 * cos(lat) km
            let areaGraus = 0;
            const n = coords.length;
            
            for (let i = 0; i < n; i++) {
                const j = (i + 1) % n;
                areaGraus += coords[i][0] * coords[j][1];
                areaGraus -= coords[j][0] * coords[i][1];
            }
            areaGraus = Math.abs(areaGraus) / 2;
            
            // Converter para km¬≤ e depois para hectares
            // Usar latitude m√©dia do pol√≠gono
            let latMedia = 0;
            coords.forEach(p => latMedia += p[0]);
            latMedia /= coords.length;
            
            const kmPorGrauLat = 111.32;
            const kmPorGrauLng = 111.32 * Math.cos(latMedia * Math.PI / 180);
            
            const areaKm2 = areaGraus * kmPorGrauLat * kmPorGrauLng;
            const areaHectares = areaKm2 * 100; // 1 km¬≤ = 100 hectares
            
            return areaHectares;
        }
        
        // Load Data
        function loadAll() {
            fetch('/api/piquetes?fazenda_id=' + fazendaId).then(r => r.json()).then(data => {
                piquetes = data;
                document.getElementById('lista-piquetes').innerHTML = data.map(p => {
                    // Verificar altura real vs estimada
                    const temReal = p.altura_real_medida !== null && p.altura_real_medida !== undefined;
                    const temAlgumaAltura = temReal || (p.altura_estimada !== null && p.altura_estimada !== undefined);
                    const fonteAlt = p.fonte_altura || 'estimada';
                    const alturaMostrada = temReal ? p.altura_real_medida : p.altura_estimada;
                    const animaisNoPiquete = p.animais_no_piquete > 0;
                    const lotesNoPiquete = p.lotes_no_piquete > 0;
                    
                    // Badge de status
                    let badgeClass = '';
                    let badgeText = '';
                    let statusInfo = '';
                    let alertaUrgente = '';
                    let diasRestantes = '';
                    let badgeFonte = fonteAlt === 'real' 
                        ? '<span style="background:#28a745;color:white;padding:1px 5px;border-radius:8px;font-size:0.7rem;margin-left:3px;">MEDIDA</span>'
                        : '<span style="background:#fd7e14;color:white;padding:1px 5px;border-radius:8px;font-size:0.7rem;margin-left:3px;">ESTIMADA</span>';
                    
                    // Se N√ÉO tem altura_real_medida, mostrar AVISO e BLOQUEAR uso
                    if (!temReal) {
                        if (!temAlgumaAltura) {
                            // Sem nenhum dado de altura
                            badgeClass = 'badge-yellow';
                            badgeText = '‚ö†Ô∏è SEM ALTURA';
                            statusInfo = '<small style="color: #856404;">Adicione a altura medida</small>';
                        } else {
                            // Tem estimativa mas n√£o tem medi√ß√£o real
                            badgeClass = 'badge-yellow';
                            badgeText = '‚ö†Ô∏è PRECISA MEDIR';
                            statusInfo = `<small style="color: #fd7e14;">üìè ${alturaMostrada}cm (estimada) - <a href="#" onclick="fecharModal('modal-ver-piquete'); setTimeout(()=>abrirModalEditarPiquete(${p.id}),300);return false;" style="color:#007bff;">Atualizar medi√ß√£o</a></small>`;
                        }
                    } else if (p.estado === 'ocupado') {
                        // Verificar se ultrapassou os dias t√©cnicos
                        const diasTecnicos = p.dias_tecnicos || 30;
                        const diasOcupados = p.dias_no_piquete || 0; // Dias decorridos no piquete
                        
                        if (diasOcupados >= diasTecnicos) {
                            // Ultrapassou o limite - AVISO URGENTE
                            badgeClass = 'badge-red';
                            badgeText = 'üî¥ SAIDA IMEDIATA';
                            statusInfo = `<small style="color: #dc3545;">‚ö†Ô∏è Tempo tecnico ultrapassado!</small>`;
                            
                            // AVISO URGENTE para piquetes ocupados que ultrapassaram limite
                            if (animaisNoPiquete) {
                                alertaUrgente = `
                                    <div style="background: #fff3cd; border: 1px solid #ffc107; border-radius: 6px; padding: 8px; margin-top: 8px; text-align: center;">
                                        <strong style="color: #856404;">‚ö†Ô∏è Tempo tecnico! ${diasOcupados}/${diasTecnicos} dias</strong><br>
                                        <a href="/fazenda/${fazendaId}/lotes" class="btn btn-warning btn-sm" style="margin-top: 5px; font-size: 0.8rem;">üîÑ Ir para Lotes</a>
                                    </div>
                                `;
                            }
                        } else {
                            badgeClass = 'badge-blue';
                            badgeText = 'üîµ Em Occupacao';
                            statusInfo = `<small style="color: #007bff;">üìè ${p.altura_estimada || '?'}cm (est.)</small>`;
                        }
                    } else if (p.altura_estimada >= p.altura_entrada) {
                        // Usar ESTIMATIVA para determinar status
                        // Se estimativa atingiu altura de entrada = dispon√≠vel
                        badgeClass = 'badge-green';
                        badgeText = 'üü¢ Dispon√≠vel';
                        statusInfo = `<small style="color: #28a745;">üìè ${p.altura_estimada}cm (estimada)</small>`;
                    } else if (temReal && p.altura_real_medida >= p.altura_entrada) {
                        // Se medi√ß√£o real atingiu = dispon√≠vel
                        badgeClass = 'badge-green';
                        badgeText = 'üü¢ Dispon√≠vel';
                        statusInfo = `<small style="color: #28a745;">üìè ${p.altura_real_medida}cm (medida)</small>`;
                    } else {
                        // Recuperando - usar a maior altura dispon√≠vel (medida ou estimada)
                        const alturaBase = Math.max(p.altura_real_medida || 0, p.altura_estimada || 0);
                        badgeClass = 'badge-orange';
                        badgeText = 'üîÑ Recuperando';
                        statusInfo = `<small style="color: #c45a00;">üìè ${alturaBase}/${p.altura_entrada} cm ${badgeFonte}</small>`;
                        
                        // AVISO URGENTE se houver animais em piquete em recupera√ß√£o
                        if (animaisNoPiquete) {
                            alertaUrgente = `
                                <div style="background: #fff3cd; border: 1px solid #ffc107; border-radius: 6px; padding: 8px; margin-top: 8px; text-align: center;">
                                    <strong style="color: #856404;">‚ö†Ô∏è ${p.animais_no_piquete} animal(is) em recupera√ß√£o!</strong><br>
                                    <a href="/fazenda/${fazendaId}/lotes" class="btn btn-warning btn-sm" style="margin-top: 5px; font-size: 0.8rem;">üîÑ Ir para Lotes</a>
                                </div>
                            `;
                        }
                        
                        // Mostrar dias de descanso faltantes se em recuperacao
                        if (!temAlgumaAltura) {
                            // Sem altura definida
                            diasRestantes = '';
                        } else if (p.estado === 'ocupado') {
                            // Em ocupacao - mostrar dias tecnicos
                            diasRestantes = `<small style="color: #004085;">üìä ${p.dias_tecnicos || 0} dias t√©cnicos</small>`;
                        } else if (alturaMostrada >= p.altura_entrada) {
                            // Ja atingiu altura (usando a mesma l√≥gica do badge)
                            diasRestantes = `<small style="color: #155724;">‚úÖ Pronto para receber!</small>`;
                        } else {
                            // Em recuperacao - usar a maior altura (medida ou estimada)
                            const alturaBase = Math.max(p.altura_real_medida || 0, p.altura_estimada || 0);
                            
                            // Mostrar dias de descanso faltantes se em recuperacao
                            if (!temAlgumaAltura) {
                                // Sem altura definida
                                diasRestantes = '';
                            } else {
                                const diasDescanso = p.dias_descanso || 0;
                                
                                // Info de crescimento
                                const crescimento = getCrescimentoCapim(p.capim);
                                const faltaCm = Math.max(0, p.altura_entrada - alturaBase);
                                
                                // Calcular dias necess√°rios baseado na ALTURA QUE FALTA
                                const diasNecessarios = Math.round(faltaCm / crescimento);
                                
                                const limiteMaximo = 30; // Alerta de inefici√™ncia
                                const progresso = Math.min(100, (diasDescanso / Math.max(1, diasNecessarios)) * 100);
                                
                                // Alerta de inefici√™ncia: passou do limite m√°ximo
                                const alertaIneficiencia = diasDescanso > limiteMaximo;
                                
                                if (faltaCm > 0) {
                                    diasRestantes = `
                                        <div style="margin-top: 8px;">
                                            <small style="color: #856404;">üìÖ ~${diasNecessarios} dia${diasNecessarios !== 1 ? 's' : ''} necess√°rio${diasNecessarios !== 1 ? 's' : ''} ${badgeFonte}</small><br>
                                            <small style="color: #6c757d;">üìà ${crescimento} cm/dia | Falta: ${faltaCm}cm</small>
                                            <div style="background: #e9ecef; border-radius: 10px; height: 8px; margin-top: 5px; overflow: hidden;">
                                                <div style="background: linear-gradient(90deg, #ffc107, #28a745); width: ${progresso}%; height: 100%;"></div>
                                            </div>
                                            ${alertaIneficiencia ? `<small style="color: #dc3545;">‚ö†Ô∏è Inefici√™ncia! Passou de ${limiteMaximo} dias</small>` : ''}
                                        </div>
                                    `;
                                } else {
                                    diasRestantes = `<small style="color: #28a745;">‚úÖ Descanso completo!</small>`;
                                }
                            }
                        }
                    }
                    
                    // Determinar classe do card baseado em ALTURA ESTIMADA (prioridade)
                    let cardClass = 'piquete-card';
                    if (!temAlgumaAltura) {
                        // Sem altura definida - neutro
                        cardClass += ' sem-altura';
                    } else if (p.estado === 'ocupado') {
                        cardClass += ' ocupado';
                    } else if (p.altura_estimada >= p.altura_entrada) {
                        // Estimativa atingiu = dispon√≠vel (verde)
                        cardClass += ' disponivel';
                    } else if (temReal && p.altura_real_medida >= p.altura_entrada) {
                        // Medi√ß√£o real atingiu = dispon√≠vel (verde)
                        cardClass += ' disponivel';
                    } else {
                        // Recuperando (laranja/amarelo)
                        cardClass += ' recuperando';
                    }
                    
                    return `
                    <div class="${cardClass}" onclick="mostrarPiquete(${p.id})" style="cursor:pointer">
                        <h4>${p.nome}</h4>
                        <p>üìê ${p.area || 0} hectares</p>
                        <p>üåø ${p.capim || 'N/I'}</p>
                        ${animaisNoPiquete ? `<p style="color: #007bff;"><strong>üêÑ ${p.animais_no_piquete} animal(is)</strong></p>` : ''}
                        ${p.dias_tecnicos ? `<p style="color: #007bff;"><strong>üìä ${p.dias_tecnicos} dias t√©cnicos</strong></p>` : ''}
                        <span class="badge ${badgeClass}">${badgeText}</span>
                        ${statusInfo ? `<br>${statusInfo}` : ''}
                        ${p.altura_real_medida ? `<small style="color: #28a745;">üìè ${p.altura_real_medida}cm (medida)</small>` : ''}
                        ${p.data_medicao ? `<small style="color: #999; font-size: 0.7rem;"><br>üìÖ ${new Date(p.data_medicao).toLocaleDateString('pt-BR')}</small>` : ''}
                        ${diasRestantes}
                        ${alertaUrgente}
                        <div style="margin-top: 10px; display: flex; gap: 5px;">
                            <button class="btn btn-primary btn-sm" onclick="event.stopPropagation(); abrirModalEditarPiquete(${p.id})">‚úèÔ∏è Editar</button>
                            <button class="btn btn-sm" style="background:#6c757d;color:white" onclick="event.stopPropagation(); mostrarPiquete(${p.id})">üëÅÔ∏è Ver</button>
                        </div>
                    </div>
                    `;
                }).join('');
                
                // Draw all piquetes on map if map exists
                if (mapPiquetes) {
                    drawAllPiquetes();
                }
            });
            
            fetch('/api/animais?fazenda_id=' + fazendaId).then(r => r.json()).then(data => {
                animais = data;
                const listaLotes = document.getElementById('lista-lotes');
                if (listaLotes) {
                    listaLotes.innerHTML = data.map(a => `
                        <tr><td>${a.nome}</td><td>${a.quantidade || 0}</td><td>${a.categoria || '-'}</td><td>${a.peso_medio || 0} kg</td></tr>
                    `).join('');
                }
                
                const movAnimal = document.getElementById('mov-animal');
                if (movAnimal) {
                    const opts = data.map(a => `<option value="${a.id}">${a.nome}</option>`).join('');
                    movAnimal.innerHTML = '<option value="">Selecione...</option>' + opts;
                }
            });
            
            fetch('/api/movimentacoes').then(r => r.json()).then(data => {
                document.getElementById('historico-mov').innerHTML = data.slice(0, 10).map(m => `
                    <tr><td>${new Date(m.data_movimentacao).toLocaleDateString()}</td><td>${m.animal_nome || '-'}</td><td>${m.origem_nome || '-'}</td><td>${m.destino_nome || '-'}</td><td>${m.motivo || '-'}</td></tr>
                `).join('');
                document.getElementById('ultimas-mov').innerHTML = data.slice(0, 5).map(m => `
                    <tr><td>${m.animal_nome || '-'}</td><td>${m.origem_nome || '-'}</td><td>${m.destino_nome || '-'}</td><td>${new Date(m.data_movimentacao).toLocaleDateString()}</td></tr>
                `).join('');
            });
            
            // Preencher selects de movimenta√ß√£o
            fetch('/api/piquetes?fazenda_id=' + fazendaId).then(r => r.json()).then(data => {
                const opts = data.map(p => `<option value="${p.id}">${p.nome}</option>`).join('');
                document.getElementById('mov-origem').innerHTML = '<option value="">Nenhum</option>' + opts;
                document.getElementById('mov-destino').innerHTML = '<option value="">Selecione...</option>' + opts;
                
                // Draw polygons on dashboard map
                if (map) {
                    drawAllPiquetesOnMap();
                }
            });
        }
        
        // Modals
        function abrirModalPiquete() { 
            // Limpar todos os campos do formul√°rio
            pontos = [];
            document.getElementById('pq-nome').value = '';
            document.getElementById('pq-capim').value = '';
            document.getElementById('pq-area').value = '0';
            document.getElementById('pq-altura-entrada').value = '0';
            document.getElementById('pq-altura-saida').value = '0';
            document.getElementById('pq-altura-atual').value = '';
            document.getElementById('pq-irrigado').value = 'nao';
            document.getElementById('pq-observacoes').value = '';
            
            document.getElementById('modal-piquete').classList.add('active'); 
            setTimeout(() => initMapDesenho(), 100); 
        }
        function fecharModalPiquete() { document.getElementById('modal-piquete').classList.remove('active'); }
        function abrirModalLote() { document.getElementById('modal-lote').classList.add('active'); }
        function fecharModalLote() { document.getElementById('modal-lote').classList.remove('active'); }
        function abrirModalVerPiquete() { document.getElementById('modal-ver-piquete').classList.add('active'); }
        function fecharModalVerPiquete() { document.getElementById('modal-ver-piquete').classList.remove('active'); }
        
        // Save
        function salvarPiquete() {
            const nome = document.getElementById('pq-nome').value || 'Piquete_' + Date.now();
            const coords = pontos.map(p => [p[1], p[0]]);
            coords.push(coords[0]);
            
            // Data da medi√ß√£o (se informada)
            const dataMedicao = document.getElementById('pq-data-medicao').value || null;
            
            fetch('/api/piquetes', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    fazenda_id: fazendaId,
                    nome,
                    capim: document.getElementById('pq-capim').value,
                    area: parseFloat(document.getElementById('pq-area').value) || 0,
                    geometria: JSON.stringify({type: 'Polygon', coordinates: [coords]}),
                    altura_entrada: parseFloat(document.getElementById('pq-altura-entrada').value) || 0,
                    altura_saida: parseFloat(document.getElementById('pq-altura-saida').value) || 0,
                    altura_atual: parseFloat(document.getElementById('pq-altura-atual').value) || null,
                    data_medicao: dataMedicao,
                    irrigado: document.getElementById('pq-irrigado').value || 'nao',
                    observacao: document.getElementById('pq-observacoes').value || null
                })
            }).then(r => r.json()).then(data => {
                alert('Piquete salvo!');
                fecharModalPiquete();
                loadAll();
            });
        }
        
        function salvarLote() {
            const nome = document.getElementById('lote-nome').value;
            if (!nome) return alert('Digite o nome!');
            
            fetch('/api/animais', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    fazenda_id: fazendaId,
                    nome,
                    quantidade: parseInt(document.getElementById('lote-qtd').value) || 1,
                    categoria: document.getElementById('lote-cat').value,
                    peso_medio: parseFloat(document.getElementById('lote-peso').value) || 0
                })
            }).then(r => r.json()).then(data => {
                alert('Lote adicionado!');
                fecharModalLote();
                loadAll();
            });
        }
        
        function novaMovimentacao() {
            const animal_id = document.getElementById('mov-animal').value;
            if (!animal_id) return alert('Selecione um animal!');
            
            fetch('/api/movimentacoes', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    animal_id: parseInt(animal_id),
                    piquete_origem_id: document.getElementById('mov-origem').value || null,
                    piquete_destino_id: document.getElementById('mov-destino').value || null,
                    quantidade: 1
                })
            }).then(r => r.json()).then(data => {
                alert('Movimenta√ß√£o registrada!');
                loadAll();
            });
        }
        
        function abrirModalEditarPiquete(id) {
            const p = piquetes.find(x => x.id === id);
            if (!p) return;
            
            document.getElementById('edit-pq-id').value = p.id;
            document.getElementById('edit-pq-nome').value = p.nome || '';
            document.getElementById('edit-pq-capim').value = p.capim || '';
            document.getElementById('edit-pq-area').value = p.area || 0;
            
            // Par√¢metros t√©cnicos
            document.getElementById('edit-pq-altura-entrada').value = p.altura_entrada || 0;
            document.getElementById('edit-pq-altura-saida').value = p.altura_saida || 0;
            
            // Par√¢metros avan√ßados - usar altura_real_medida se existir
            const alturaReal = p.altura_real_medida !== null && p.altura_real_medida !== undefined 
                ? p.altura_real_medida 
                : '';
            document.getElementById('edit-pq-altura-atual').value = alturaReal;
            
            // Data da medi√ß√£o
            document.getElementById('edit-pq-data-medicao').value = p.data_medicao || '';
            
            document.getElementById('edit-pq-irrigado').value = p.irrigado || 'nao';
            document.getElementById('edit-pq-observacoes').value = p.observacao || '';
            
            // Atualizar info do capim
            atualizarInfoCapimEdit();
            
            // Travar √°rea se tiver geometria
            if (p.geometria) {
                document.getElementById('edit-pq-area').setAttribute('readonly', true);
                document.getElementById('edit-pq-area').style.background = '#f5f5f5';
            } else {
                document.getElementById('edit-pq-area').removeAttribute('readonly');
                document.getElementById('edit-pq-area').style.background = 'white';
            }
            
            document.getElementById('modal-editar-piquete').classList.add('active');
        }
        
        function atualizarInfoCapimEdit() {
            const capim = document.getElementById('edit-pq-capim').value;
            const infoDiv = document.getElementById('edit-info-capim');
            
            if (capim && dadosCapins[capim]) {
                const dados = dadosCapins[capim];
                infoDiv.innerHTML = `<strong>‚ÑπÔ∏è ${capim}</strong><br>${dados.descricao}`;
                infoDiv.style.display = 'block';
            } else {
                infoDiv.style.display = 'none';
            }
        }
        
        function validarSalvarEdicaoPiquete() {
            const nome = document.getElementById('edit-pq-nome').value.trim();
            const capim = document.getElementById('edit-pq-capim').value;
            const area = parseFloat(document.getElementById('edit-pq-area').value) || 0;
            const alturaEntrada = parseFloat(document.getElementById('edit-pq-altura-entrada').value) || 0;
            const alturaSaida = parseFloat(document.getElementById('edit-pq-altura-saida').value) || 0;
            const alturaAtual = document.getElementById('edit-pq-altura-atual').value.trim();
            const dataMedicao = document.getElementById('edit-pq-data-medicao').value.trim();
            
            // Valida√ß√µes obrigat√≥rias
            if (!nome) return alert('‚ùå Informe o nome do piquete!');
            if (!capim) return alert('‚ùå Selecione o tipo de capim!');
            if (area <= 0) return alert('‚ùå A √°rea deve ser maior que 0!');
            if (alturaEntrada <= 0) return alert('‚ùå Informe a altura de entrada!');
            if (alturaSaida <= 0) return alert('‚ùå Informe a altura m√≠nima de sa√≠da!');
            if (alturaSaida >= alturaEntrada) return alert('‚ùå A altura de sa√≠da deve ser MENOR que a altura de entrada!');
            if (alturaAtual && !dataMedicao) return alert('‚ùå Se informar a Altura Atual, informe tamb√©m a Data da Medi√ß√£o!');
            
            salvarEdicaoPiquete();
        }
        
        function fecharModalEditarPiquete() {
            document.getElementById('modal-editar-piquete').classList.remove('active');
        }
        
        function salvarEdicaoPiquete() {
            const id = document.getElementById('edit-pq-id').value;
            if (!id) return;
            
            const valorAltura = document.getElementById('edit-pq-altura-atual').value.trim();
            const dataMedicao = document.getElementById('edit-pq-data-medicao').value.trim();
            const p = piquetes.find(x => x.id == id);
            const alturaAnterior = p.altura_real_medida !== null && p.altura_real_medida !== undefined 
                ? p.altura_real_medida 
                : p.altura_atual;
            
            const bodyObj = {
                nome: document.getElementById('edit-pq-nome').value,
                capim: document.getElementById('edit-pq-capim').value,
                area: parseFloat(document.getElementById('edit-pq-area').value) || 0,
                altura_entrada: parseFloat(document.getElementById('edit-pq-altura-entrada').value) || 0,
                altura_saida: parseFloat(document.getElementById('edit-pq-altura-saida').value) || 0,
                data_medicao: dataMedicao || null,
                irrigado: document.getElementById('edit-pq-irrigado').value || 'nao',
                observacao: document.getElementById('edit-pq-observacoes').value || null
            };
            
            if (valorAltura === '') {
                bodyObj.altura_atual = null;
                bodyObj.data_medicao = null;
                bodyObj.limpar_altura = true;
            } else {
                const novaAltura = parseFloat(valorAltura);
                if (!isNaN(novaAltura) && novaAltura !== alturaAnterior) {
                    bodyObj.altura_atual = novaAltura;
                    // Se mudou a altura e n√£o tem data_medicao informada, usar hoje
                    if (!dataMedicao) {
                        bodyObj.data_medicao = new Date().toISOString().split('T')[0];
                    }
                }
            }
            
            fetch('/api/piquetes/' + id, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(bodyObj)
            }).then(r => r.json()).then(data => {
                if (data.status === 'ok') {
                    alert('Piquete atualizado!');
                    fecharModalEditarPiquete();
                    loadAll();
                } else {
                    alert('Erro ao atualizar!');
                }
            });
        }
        
        function excluirPiquete() {
            const id = document.getElementById('edit-pq-id').value;
            if (!id) return;
            
            if (!confirm('Tem certeza que deseja excluir este piquete?')) return;
            
            fetch('/api/piquetes/' + id, { method: 'DELETE' })
                .then(r => r.json()).then(data => {
                    if (data.status === 'ok') {
                        alert('Piquete exclu√≠do!');
                        fecharModalEditarPiquete();
                        loadAll();
                    } else {
                        alert('Erro ao excluir!');
                    }
                });
        }
        
        function centralizarLocalizacao() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        mapDesenho.setView([lat, lng], 16);
                        
                        // Adicionar marcador
                        L.marker([lat, lng], {
                            icon: L.divIcon({
                                className: 'custom-marker',
                                html: 'üìç',
                                iconSize: [30, 30],
                                iconAnchor: [15, 30]
                            })
                        }).addTo(mapDesenho).bindPopup('Sua localiza√ß√£o').openPopup();
                    },
                    function(error) {
                        alert('Erro ao obter localiza√ß√£o: ' + error.message);
                    }
                );
            } else {
                alert('Geolocaliza√ß√£o n√£o suportada pelo navegador!');
            }
        }
        
        function drawAllPiquetes() {
            if (!mapPiquetes) return;
            
            // Limpar pol√≠gonos E labels dos piquetes
            mapPiquetes.eachLayer(function(layer) {
                if (layer instanceof L.Polygon || (layer instanceof L.Marker && layer.options?.icon?.options?.className === 'piquete-label')) {
                    mapPiquetes.removeLayer(layer);
                }
            });
            
            piquetes.forEach(p => {
                if (p.geometria) {
                    try {
                        const geo = JSON.parse(p.geometria);
                        if (geo.type === 'Polygon' && geo.coordinates && geo.coordinates.length > 0) {
                            const coords = geo.coordinates[0].map(c => [c[1], c[0]]); // lng,lat -> lat,lng
                            
                            // Determinar cor baseada no estado E ALTURA ESTIMADA
                            let corPoligono = '#28a745'; // verde = dispon√≠vel
                            const temReal = p.altura_real_medida !== null && p.altura_real_medida !== undefined;
                            const temAlgumaAltura = temReal || (p.altura_estimada !== null && p.altura_estimada !== undefined);
                            const fonteAlt = p.fonte_altura || 'estimada';
                            
                            if (!temAlgumaAltura) {
                                corPoligono = '#fd7e14'; // laranja = aguardando altura
                            } else if (p.estado === 'ocupado') {
                                corPoligono = '#dc3545'; // vermelho = ocupado
                            } else if (p.altura_estimada >= p.altura_entrada) {
                                corPoligono = '#28a745'; // verde = dispon√≠vel (baseado na estimativa)
                            } else if (temReal && p.altura_real_medida >= p.altura_entrada) {
                                corPoligono = '#28a745'; // verde = dispon√≠vel (baseado na medi√ß√£o)
                            } else {
                                corPoligono = '#ffc107'; // amarelo = recuperando
                            }
                            
                            // Animais no piquete
                            const animaisInfo = p.animais_no_piquete > 0 
                                ? `<br><strong style="color:#007bff;">üêÑ ${p.animais_no_piquete} animal(is)</strong>` 
                                : '';
                            
                            // Badge de fonte
                            const badgeFonte = fonteAlt === 'real'
                                ? '<br><span style="background:#28a745;color:white;padding:2px 6px;border-radius:8px;font-size:0.75rem;">üìè MEDIDA</span>'
                                : '<br><span style="background:#fd7e14;color:white;padding:2px 6px;border-radius:8px;font-size:0.75rem;">üìê ESTIMADA</span>';
                            
                            // Dias de descanso - MAPA PIQUETES
                            let diasInfo = '';
                            if (!temAlgumaAltura) {
                                diasInfo = `<br>‚ö†Ô∏è Aguardando altura`;
                            } else if (p.estado === 'ocupado') {
                                diasInfo = `<br>üìä ${p.dias_tecnicos || 0} dias t√©cnicos${badgeFonte}`;
                                if (p.altura_estimada) {
                                    diasInfo += `<br>üìè Altura: ${p.altura_estimada}/${p.altura_entrada || '?'} cm`;
                                }
                            } else if (p.altura_estimada >= p.altura_entrada) {
                                diasInfo = `<br>üü¢ APTO para entrada${badgeFonte}`;
                                if (p.altura_estimada) {
                                    diasInfo += `<br>üìè Altura: ${p.altura_estimada} cm`;
                                }
                            } else {
                                const diasDescanso = p.dias_descanso || 0;
                                const diasMin = p.dias_descanso_min || 30;
                                const faltam = Math.max(0, diasMin - diasDescanso);
                                diasInfo = `<br>üîÑ ${diasDescanso}/${diasMin} dias (falta ${faltam})${badgeFonte}`;
                                if (p.altura_estimada) {
                                    diasInfo += `<br>üìè Altura: ${p.altura_estimada}/${p.altura_entrada || '?'} cm`;
                                }
                            }
                            
                            // Aviso urgente se animais em piquete em recupera√ß√£o
                            const avisoUrgente = (p.animais_no_piquete > 0 && p.altura_estimada && p.altura_estimada < p.altura_entrada)
                                ? `<br><strong style="color:#dc3545;">üö® AVISO: Remova urgentemente!</strong>`
                                : '';

                            // Badge de status (igual ao card)
                            let badgeClass = '';
                            let badgeText = '';
                            let statusInfo = '';
                            let diasRestantes = '';
                            
                            if (!temAlgumaAltura) {
                                badgeClass = 'badge-yellow';
                                badgeText = '‚ö†Ô∏è SEM ALTURA';
                                statusInfo = '<small style="color: #856404;">Adicione a altura medida</small>';
                            } else if (p.estado === 'ocupado') {
                                badgeClass = 'badge-blue';
                                badgeText = 'üîµ Em Ocupa√ß√£o';
                                statusInfo = `<small style="color: #007bff;">üìè ${p.altura_estimada || '?'}cm (est.)</small>`;
                            } else if (p.altura_estimada >= p.altura_entrada) {
                                badgeClass = 'badge-green';
                                badgeText = 'üü¢ Dispon√≠vel';
                                statusInfo = `<small style="color: #28a745;">üìè ${p.altura_estimada}cm (estimada)</small>`;
                            } else if (temReal && p.altura_real_medida >= p.altura_entrada) {
                                badgeClass = 'badge-green';
                                badgeText = 'üü¢ Dispon√≠vel';
                                statusInfo = `<small style="color: #28a745;">üìè ${p.altura_real_medida}cm (medida)</small>`;
                            } else {
                                badgeClass = 'badge-orange';
                                badgeText = 'üîÑ Recuperando';
                                statusInfo = `<small style="color: #c45a00;">üìè ${Math.max(p.altura_real_medida || 0, p.altura_estimada || 0)}/${p.altura_entrada} cm ${badgeFonte}</small>`;
                            }

                            // Dias restantes (igual ao card)
                            if (!temAlgumaAltura) {
                                diasRestantes = '';
                            } else if (p.estado === 'ocupado') {
                                diasRestantes = `<br><small style="color: #004085;">üìä ${p.dias_tecnicos || 0} dias t√©cnicos</small>`;
                            } else if (p.altura_estimada >= p.altura_entrada) {
                                diasRestantes = `<br><small style="color: #155724;">‚úÖ Pronto para receber!</small>`;
                            } else {
                                const diasDescanso = p.dias_descanso || 0;
                                const crescimento = 1.2; // Valor padr√£o
                                const faltaCm = Math.max(0, p.altura_entrada - (p.altura_estimada || 0));
                                const diasNecessarios = Math.round(faltaCm / crescimento);
                                diasRestantes = `<br><small style="color: #856404;">üìÖ ~${diasNecessarios} dias necess√°rio${diasNecessarios !== 1 ? 's' : ''} ${badgeFonte}</small><br><small style="color: #6c757d;">üìà ${crescimento} cm/dia | Falta: ${faltaCm}cm</small>`;
                            }

                            // Popup completo (igual ao card)
                            L.polygon(coords, {
                                color: corPoligono,
                                weight: 3,
                                fill: true,
                                fillOpacity: 0.4
                            }).addTo(mapPiquetes).bindPopup(`
                                <div style="min-width:200px;">
                                    <strong style="font-size:14px;">${p.nome}</strong><br>
                                    <span class="badge ${badgeClass}" style="font-size:0.7rem;">${badgeText}</span><br>
                                    <p style="margin:5px 0;">üìê ${p.area || 0} hectares | üåø ${p.capim || 'N/I'}</p>
                                    ${p.animais_no_piquete > 0 ? `<p style="color:#007bff;margin:5px 0;"><strong>üêÑ ${p.animais_no_piquete} animal(is)</strong></p>` : ''}
                                    ${p.altura_real_medida ? `<p style="color:#28a745;margin:5px 0;">üìè ${p.altura_real_medida}cm (medida)</p>` : ''}
                                    ${p.data_medicao ? `<p style="color:#999;font-size:0.75rem;margin:5px 0;">üìÖ ${new Date(p.data_medicao).toLocaleDateString('pt-BR')}</p>` : ''}
                                    ${statusInfo ? `<p style="margin:5px 0;">${statusInfo}</p>` : ''}
                                    ${diasRestantes}
                                    ${avisoUrgente}
                                </div>
                            `);
                            
                            // Add label in center of polygon (igual ao dashboard)
                            if (coords.length > 0) {
                                let latSum = 0, lngSum = 0;
                                coords.forEach(c => { latSum += c[0]; lngSum += c[1]; });
                                const centerLat = latSum / coords.length;
                                const centerLng = lngSum / coords.length;
                                
                                const label = L.divIcon({
                                    className: 'piquete-label',
                                    html: `<div style="background:rgba(255,255,255,0.9);padding:2px 6px;border-radius:4px;font-size:11px;font-weight:bold;color:#1a1a2e;text-shadow:1px 1px 0 #fff;box-shadow:0 1px 3px rgba(0,0,0,0.2);">${p.nome}</div>`,
                                    iconSize: [80, 20],
                                    iconAnchor: [40, 10]
                                });
                                L.marker([centerLat, centerLng], {icon: label}).addTo(mapPiquetes);
                            }
                        }
                    } catch (e) {
                        console.log('Erro ao desenhar poligono no mapa de piquetes', p.id);
                    }
                }
            });
        }
        
        function mostrarPiquete(id) {
            const p = piquetes.find(x => x.id === id);
            if (!p) return;
            
            // Switch to piquetes tab and show map
            document.querySelectorAll('.menu-item').forEach(i => i.classList.remove('active'));
            document.querySelector('.menu-item:nth-child(2)').classList.add('active');
            document.querySelectorAll('[id$="-section"]').forEach(s => s.style.display = 'none');
            document.getElementById('piquetes-section').style.display = 'block';
            
            // Inicializar mapa da aba Piquetes
            setTimeout(() => {
                if (!mapPiquetes) {
                    mapPiquetes = L.map('map-piquetes').setView([mapaLat, mapaLng], 15);
                    L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {attribution: 'Esri'}).addTo(mapPiquetes);
                }
                mapPiquetes.invalidateSize();
                
                // Draw all and zoom to selected
                drawAllPiquetes();
                
                if (p.geometria) {
                    try {
                        const geo = JSON.parse(p.geometria);
                        if (geo.type === 'Polygon' && geo.coordinates && geo.coordinates.length > 0) {
                            const coords = geo.coordinates[0].map(c => [c[1], c[0]]);
                            const bounds = L.latLngBounds(coords.map(c => [c[0], c[1]]));
                            mapPiquetes.fitBounds(bounds, {padding: [50, 50]});
                            
                            // Cor baseada no estado real
                            let corPoligono = '#28a745'; // dispon√≠vel
                            if (p.estado === 'ocupado') corPoligono = '#dc3545';
                            else if (p.altura_atual && p.altura_atual < p.altura_entrada) corPoligono = '#ffc107';
                            else if (!p.altura_atual) corPoligono = '#fd7e14';
                            
                            L.polygon(coords, {
                                color: corPoligono,
                                weight: 4,
                                fill: true,
                                fillOpacity: 0.4
                            }).addTo(mapPiquetes).bindPopup(`
                                <strong>${p.nome}</strong><br>
                                üåø ${p.capim || 'N/I'}<br>
                                üìê ${p.area || 0} hectares<br>
                                üìè ${p.altura_atual || '?'}/${p.altura_entrada || '?'} cm<br>
                                ${p.estado === 'ocupado' 
                                    ? `üìä ${p.dias_tecnicos || 0} dias t√©cnicos${p.data_saida_prevista ? ' ‚Ä¢ üìÜ ' + p.data_saida_prevista : ''}`
                                    : `üìÖ ${p.dias_descanso || 0}/${p.dias_descanso_min || 30} dias descanso`}
                            `).openPopup();
                        }
                    } catch (e) {
                        console.log('Erro ao mostrar piquete', e);
                    }
                }
            }, 200);
            
            // Calcular status real baseado em altura_real_medida ou altura_estimada
            const temReal = p.altura_real_medida !== null && p.altura_real_medida !== undefined;
            const temAlgumaAltura = temReal || (p.altura_estimada !== null && p.altura_estimada !== undefined);
            const fonteAlt = p.fonte_altura || 'estimada';
            
            let estadoTexto = '';
            let estadoCor = '';
            let estadoBadge = '';
            let alturaInfo = '';
            let alturaBadge = '';
            
            // Badge de fonte da altura
            if (fonteAlt === 'real') {
                alturaBadge = '<span style="background:#28a745;color:white;padding:2px 8px;border-radius:10px;font-size:0.75rem;margin-left:5px;">üìè MEDIDA</span>';
            } else {
                alturaBadge = '<span style="background:#fd7e14;color:white;padding:2px 8px;border-radius:10px;font-size:0.75rem;margin-left:5px;">üìê ESTIMADA</span>';
            }
            
            if (!temAlgumaAltura) {
                estadoTexto = '‚ö†Ô∏è Aguardando Altura';
                estadoCor = '#fd7e14';
                estadoBadge = 'badge-orange';
                alturaInfo = `<p style="color:#fd7e14;"><strong>‚ö†Ô∏è Altura n√£o calculada</strong><br>√â necess√°rio informar a altura inicial</p>`;
            } else if (p.estado === 'ocupado') {
                estadoTexto = 'üîµ Em Ocupa√ß√£o';
                estadoCor = '#004085';
                estadoBadge = 'badge-blue';
                const alturaMostrada = Math.max(p.altura_real_medida || 0, p.altura_estimada || 0);
                alturaInfo = `<p><strong>Altura Atual:</strong> ${alturaMostrada} cm ${alturaBadge}</p>`;
            } else if (p.altura_estimada >= p.altura_entrada) {
                // Se estimativa atingiu = dispon√≠vel
                estadoTexto = 'üü¢ Dispon√≠vel';
                estadoCor = '#155724';
                estadoBadge = 'badge-green';
                alturaInfo = `<p><strong>Altura Atual:</strong> ${p.altura_estimada} cm ${alturaBadge}</p>`;
            } else if (temReal && p.altura_real_medida >= p.altura_entrada) {
                // Se medi√ß√£o real atingiu = dispon√≠vel
                estadoTexto = 'üü¢ Dispon√≠vel';
                estadoCor = '#155724';
                estadoBadge = 'badge-green';
                alturaInfo = `<p><strong>Altura Atual:</strong> ${p.altura_real_medida} cm ${alturaBadge}</p>`;
            } else {
                // Recuperando - usar a maior altura
                estadoTexto = 'üîÑ Recuperando';
                estadoCor = '#856404';
                estadoBadge = 'badge-yellow';
                const alturaMostrada = Math.max(p.altura_real_medida || 0, p.altura_estimada || 0);
                alturaInfo = `<p><strong>Altura Atual:</strong> ${alturaMostrada} cm ${alturaBadge}</p>`;
            }
            
            // Dias de descanso info
            let diasInfo = '';
            let crescimentoInfo = '';
            if (p.estado === 'ocupado') {
                diasInfo = `<p><strong>Dias T√©cnicos:</strong> ${p.dias_tecnicos || 0}</p>`;
            } else if (!temAlgumaAltura) {
                diasInfo = `<p><strong>Dias de Descanso:</strong> ${p.dias_descanso || 0}</p>`;
                const diasMin = calcularDiasNecessarios(p.capim, p.altura_entrada, p.altura_saida);
                const crescimento = getCrescimentoCapim(p.capim);
                diasInfo += `<p style="color:#6c757d;"><strong>Necess√°rios:</strong> ~${diasMin} dias<br><small>(Crescimento: ${crescimento} cm/dia)</small></p>`;
            } else if (p.altura_estimada >= p.altura_entrada) {
                // Se estimativa atingiu = apto
                diasInfo = `<p style="color:#28a745;"><strong>‚úÖ APTO para receber animais!</strong></p>`;
            } else if (temReal && p.altura_real_medida >= p.altura_entrada) {
                // Se medi√ß√£o real atingiu = apto
                diasInfo = `<p style="color:#28a745;"><strong>‚úÖ APTO para receber animais!</strong></p>`;
            } else {
                const diasDescanso = p.dias_descanso || 0;
                const crescimento = getCrescimentoCapim(p.capim);
                // Usar a maior altura dispon√≠vel
                const alturaMostrada = Math.max(p.altura_real_medida || 0, p.altura_estimada || 0);
                const faltaCm = Math.max(0, p.altura_entrada - alturaMostrada);
                
                // Calcular dias necess√°rios baseado na ALTURA QUE FALTA
                const diasNecessarios = Math.round(faltaCm / crescimento);
                
                diasInfo = `<p><strong>Dias de Descanso:</strong> ${diasDescanso}/${diasNecessarios} (necess√°rios)</p>`;
                diasInfo += `<p style="color:#6c757d;"><small>Crescimento: ${crescimento} cm/dia | Falta: ${faltaCm}cm</small></p>`;
                
                if (diasDescanso > 30) {
                    diasInfo += `<p style="color:#dc3545;"><strong>‚ö†Ô∏è Inefici√™ncia!</strong><br><small>Passou de 30 dias sem atingir altura</small></p>`;
                }
            }
            
            // Mostrar se tem estimativa dispon√≠vel
            let estimativaInfo = '';
            if (temReal && p.altura_estimada !== null) {
                const diff = p.altura_estimada - p.altura_real_medida;
                const sinal = diff >= 0 ? '+' : '';
                estimativaInfo = `<p style="color:#6c757d;font-size:0.85rem;margin-top:5px;"><strong>Estimativa do sistema:</strong> ${p.altura_estimada} cm (${sinal}${diff.toFixed(1)} cm)</p>`;
            } else if (!temReal && p.altura_estimada !== null) {
                estimativaInfo = `<p style="color:#fd7e14;font-size:0.85rem;margin-top:5px;"><strong>‚ö†Ô∏è Valor estimado</strong> - <a href="#" onclick="fecharModal('modal-ver-piquete'); setTimeout(()=>abrirModalEditarPiquete(${p.id}),300);return false;" style="color:#007bff;">Atualizar medi√ß√£o</a></p>`;
            }
            
            // Show info in modal
            document.getElementById('info-piquete').innerHTML = `
                <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <h4 style="margin-bottom: 10px; color: #1976d2;">üìç ${p.nome}</h4>
                    <p><strong>√Årea:</strong> ${p.area || 0} hectares</p>
                    <p><strong>Capim:</strong> ${p.capim || 'N/I'}</p>
                    <p><strong>Estado:</strong> <span class="badge ${estadoBadge}" style="color: white;">${estadoTexto}</span></p>
                    ${diasInfo}
                </div>
                
                <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <h4 style="margin-bottom: 10px; color: #856404;">‚öôÔ∏è Par√¢metros T√©cnicos</h4>
                    <p><strong>Altura de Entrada:</strong> ${p.altura_entrada || 0} cm</p>
                    <p><strong>Altura M√≠nima de Sa√≠da:</strong> ${p.altura_saida || 0} cm</p>
                    ${p.dias_tecnicos ? `<p style="color: #1976d2;"><strong>üìä Dias T√©cnicos de Ocupa√ß√£o:</strong> ${p.dias_tecnicos} dias</p>` : ''}
                    ${p.data_saida_prevista ? `<p style="color: #1976d2;"><strong>üìÜ Sa√≠da Prevista:</strong> ${p.data_saida_prevista}</p>` : ''}
                    ${alturaInfo}
                    ${estimativaInfo}
                </div>
                
                ${(p.irrigado === 'sim' || p.observacao) ? `
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <h4 style="margin-bottom: 10px; color: #495057;">üîß Par√¢metros Avan√ßados</h4>
                    ${p.irrigado === 'sim' ? '<p><strong>Irrigado:</strong> Sim</p>' : ''}
                    ${p.observacao ? `<p><strong>Observa√ß√µes:</strong> ${p.observacao}</p>` : ''}
                </div>
                ` : ''}
                
                <p style="color: #666; font-size: 0.85rem;">üìÖ Criado em: ${p.created_at ? new Date(p.created_at).toLocaleDateString() : 'N/I'}</p>
            `;
            abrirModalVerPiquete();
        }
        
        // Buscar endere√ßo no mapa
        function buscarEndereco() {
            const endereco = document.getElementById('endereco-busca').value;
            if (!endereco) return alert('Digite um endere√ßo!');
            
            // Usar Nominatim (OpenStreetMap) para geocodifica√ß√£o
            const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(endereco)}&limit=1`;
            
            fetch(url)
                .then(r => r.json())
                .then(data => {
                    if (data && data.length > 0) {
                        const lat = parseFloat(data[0].lat);
                        const lon = parseFloat(data[0].lon);
                        
                        // Garantir que o mapa existe
                        if (!mapPiquetes) {
                            mapPiquetes = L.map('map-piquetes').setView([lat, lon], 15);
                            L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {attribution: 'Esri'}).addTo(mapPiquetes);
                        } else {
                            mapPiquetes.setView([lat, lon], 15);
                        }
                        
                        // Adicionar marcador
                        L.marker([lat, lon], {
                            icon: L.divIcon({
                                className: 'custom-marker',
                                html: 'üìç',
                                iconSize: [30, 30],
                                iconAnchor: [15, 30]
                            })
                        }).addTo(mapPiquetes).bindPopup(data[0].display_name.substring(0, 80) + '...').openPopup();
                        
                    } else {
                        alert('Endere√ßo n√£o encontrado!');
                    }
                })
                .catch(e => {
                    alert('Erro ao buscar endere√ßo: ' + e.message);
                });
        }
        
        // Geolocaliza√ß√£o no mapa de piquetes
        function geoLocalizacaoMapaPiquetes() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        
                        // Garantir que o mapa existe
                        if (!mapPiquetes) {
                            mapPiquetes = L.map('map-piquetes').setView([lat, lng], 16);
                            L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {attribution: 'Esri'}).addTo(mapPiquetes);
                        } else {
                            mapPiquetes.setView([lat, lng], 16);
                        }
                        
                        // Adicionar marcador
                        L.marker([lat, lng], {
                            icon: L.divIcon({
                                className: 'custom-marker',
                                html: 'üìç',
                                iconSize: [30, 30],
                                iconAnchor: [15, 30]
                            })
                        }).addTo(mapPiquetes).bindPopup('Sua localiza√ß√£o').openPopup();
                    },
                    function(error) {
                        alert('Erro ao obter localiza√ß√£o: ' + error.message);
                    }
                );
            } else {
                alert('Geolocaliza√ß√£o n√£o suportada pelo navegador!');
            }
        }
        
        // Geolocaliza√ß√£o no dashboard
        function geoLocalizacaoDashboard() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        map.setView([lat, lng], 16);
                        L.marker([lat, lng], {
                            icon: L.divIcon({
                                className: 'custom-marker',
                                html: 'üìç',
                                iconSize: [30, 30],
                                iconAnchor: [15, 30]
                            })
                        }).addTo(map).bindPopup('Sua localiza√ß√£o').openPopup();
                    },
                    function(error) {
                        alert('Erro ao obter localiza√ß√£o: ' + error.message);
                    }
                );
            } else {
                alert('Geolocaliza√ß√£o n√£o suportada pelo navegador!');
            }
        }
        
        // Buscar endere√ßo no dashboard
        function buscarEnderecoDashboard() {
            const endereco = document.getElementById('endereco-dashboard').value;
            if (!endereco) return alert('Digite um endere√ßo!');
            
            const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(endereco)}&limit=1`;
            
            fetch(url)
                .then(r => r.json())
                .then(data => {
                    if (data && data.length > 0) {
                        const lat = parseFloat(data[0].lat);
                        const lon = parseFloat(data[0].lon);
                        map.setView([lat, lon], 15);
                        L.marker([lat, lon], {
                            icon: L.divIcon({
                                className: 'custom-marker',
                                html: 'üìç',
                                iconSize: [30, 30],
                                iconAnchor: [15, 30]
                            })
                        }).addTo(map).bindPopup(data[0].display_name.substring(0, 80) + '...').openPopup();
                    } else {
                        alert('Endere√ßo n√£o encontrado!');
                    }
                })
                .catch(e => {
                    alert('Erro ao buscar endere√ßo: ' + e.message);
                });
        }
        
        // ========== DADOS DOS CAPINS ==========
        const dadosCapins = {
            'Brachiaria': {
                alturaEntrada: 30,
                alturaSaida: 15,
                diasOcupacao: 3,
                crescimentoDiario: 1.2,
                descricao: '‚Ä¢ Altura entrada: 25‚Äì30 cm<br>‚Ä¢ Altura sa√≠da: 15 cm<br>‚Ä¢ Crescimento: ~1.2 cm/dia'
            },
            'Momba√ßa': {
                alturaEntrada: 35,
                alturaSaida: 20,
                diasOcupacao: 3,
                crescimentoDiario: 1.5,
                descricao: '‚Ä¢ Altura entrada: 35‚Äì40 cm<br>‚Ä¢ Altura sa√≠da: 20 cm<br>‚Ä¢ Crescimento: ~1.5 cm/dia'
            },
            'Tifton 85': {
                alturaEntrada: 20,
                alturaSaida: 10,
                diasOcupacao: 3,
                crescimentoDiario: 1.0,
                descricao: '‚Ä¢ Altura entrada: 20‚Äì25 cm<br>‚Ä¢ Altura sa√≠da: 10 cm<br>‚Ä¢ Crescimento: ~1.0 cm/dia'
            },
            'Andropogon': {
                alturaEntrada: 25,
                alturaSaida: 12,
                diasOcupacao: 3,
                crescimentoDiario: 1.2,
                descricao: '‚Ä¢ Altura entrada: 25‚Äì30 cm<br>‚Ä¢ Altura sa√≠da: 12 cm<br>‚Ä¢ Crescimento: ~1.2 cm/dia'
            },
            'Capim Aruana': {
                alturaEntrada: 25,
                alturaSaida: 15,
                diasOcupacao: 3,
                crescimentoDiario: 1.1,
                descricao: '‚Ä¢ Altura entrada: 25 cm<br>‚Ä¢ Altura sa√≠da: 15 cm<br>‚Ä¢ Crescimento: ~1.1 cm/dia'
            },
            'Natalino': {
                alturaEntrada: 30,
                alturaSaida: 15,
                diasOcupacao: 3,
                crescimentoDiario: 1.3,
                descricao: '‚Ä¢ Altura entrada: 30 cm<br>‚Ä¢ Altura sa√≠da: 15 cm<br>‚Ä¢ Crescimento: ~1.3 cm/dia'
            },
            'MG-5': {
                alturaEntrada: 35,
                alturaSaida: 18,
                diasOcupacao: 3,
                crescimentoDiario: 1.4,
                descricao: '‚Ä¢ Altura entrada: 35 cm<br>‚Ä¢ Altura sa√≠da: 18 cm<br>‚Ä¢ Crescimento: ~1.4 cm/dia'
            },
            'Outro': {
                alturaEntrada: 25,
                alturaSaida: 15,
                diasOcupacao: 3,
                crescimentoDiario: 1.2,
                descricao: '‚Ä¢ Defina os valores manualmente<br>‚Ä¢ Consulta um agr√¥nomo para orienta√ß√£o'
            }
        };
        
        // Retorna crescimento di√°rio do capim
        function getCrescimentoCapim(capim) {
            if (capim && dadosCapins[capim]) {
                return dadosCapins[capim].crescimentoDiario;
            }
            return 1.2; // Padr√£o
        }
        
        // Calcula dias necess√°rios para recupera√ß√£o
        function calcularDiasNecessarios(capim, alturaEntrada, alturaSaida) {
            if (!capim || !dadosCapins[capim]) {
                return 30; // Fallback
            }
            const crescimento = dadosCapins[capim].crescimentoDiario;
            const alturaNecessaria = alturaEntrada - alturaSaida;
            if (crescimento <= 0) return 30;
            return Math.max(1, Math.round(alturaNecessaria / crescimento));
        }
        
        // Atualizar info do capim quando selecionado
        function atualizarInfoCapim() {
            const capim = document.getElementById('pq-capim').value;
            const infoDiv = document.getElementById('info-capim');
            
            if (capim && dadosCapins[capim]) {
                const dados = dadosCapins[capim];
                infoDiv.innerHTML = `<strong>‚ÑπÔ∏è ${capim}</strong><br>${dados.descricao}`;
                infoDiv.style.display = 'block';
                
                // Preencher valores padr√£o
                document.getElementById('pq-altura-entrada').value = dados.alturaEntrada;
                document.getElementById('pq-altura-saida').value = dados.alturaSaida;
            } else {
                infoDiv.style.display = 'none';
            }
        }
        
        // Liberar √°rea manual
        function liberarAreaManual() {
            const areaInput = document.getElementById('pq-area');
            areaInput.removeAttribute('readonly');
            areaInput.style.background = 'white';
            areaInput.focus();
        }
        
        // Desfazer √∫ltimo ponto
        function desfazerPonto() {
            if (pontos.length > 0) {
                pontos.pop();
                atualizarDesenho();
            }
        }
        
        // Limpar todo o desenho
        function limparDesenho() {
            pontos = [];
            document.getElementById('pq-area').value = '0';
            atualizarDesenho();
        }
        
        // Validar e salvar piquete
        function validarSalvarPiquete() {
            const nome = document.getElementById('pq-nome').value.trim();
            const capim = document.getElementById('pq-capim').value;
            const area = parseFloat(document.getElementById('pq-area').value) || 0;
            const alturaEntrada = parseFloat(document.getElementById('pq-altura-entrada').value) || 0;
            const alturaSaida = parseFloat(document.getElementById('pq-altura-saida').value) || 0;
            const alturaAtual = document.getElementById('pq-altura-atual').value.trim();
            const dataMedicao = document.getElementById('pq-data-medicao').value.trim();
            
            // Valida√ß√µes obrigat√≥rias
            if (!nome) return alert('‚ùå Informe o nome do piquete!');
            if (!capim) return alert('‚ùå Selecione o tipo de capim!');
            if (area <= 0) return alert('‚ùå A √°rea deve ser maior que 0!');
            if (alturaEntrada <= 0) return alert('‚ùå Informe a altura ideal de entrada!');
            if (alturaSaida <= 0) return alert('‚ùå Informe a altura m√≠nima de sa√≠da!');
            if (alturaSaida >= alturaEntrada) return alert('‚ùå A altura de sa√≠da deve ser MENOR que a altura de entrada!');
            if (alturaAtual && !dataMedicao) return alert('‚ùå Se informar a Altura Atual, informe tamb√©m a Data da Medi√ß√£o!');
            
            // Se n√£o desenhou polygon
            if (pontos.length < 3 && area <= 0) {
                return alert('‚ùå Desenhe o piquete no mapa OU libere a √°rea manual!');
            }
            
            salvarPiquete();
        }
        
        // REMOVIDO: window.onload movido para o final do arquivo
        
        // Carregar informa√ß√µes de lota√ß√£o
        function carregarLotacao() {
            fetch('/api/lotacao/' + fazendaId)
                .then(r => r.json())
                .then(data => {
                    if (data && data.ua_total !== undefined) {
                        document.getElementById('lotacao-peso').textContent = (data.peso_total || 0).toLocaleString('pt-BR');
                        document.getElementById('lotacao-ua').textContent = data.ua_total;
                        document.getElementById('lotacao-lha').textContent = data.lotacao_ha;
                        
                        // Status based on lota√ß√£o
                        const lha = data.lotacao_ha;
                        const statusEl = document.getElementById('lotacao-status');
                        const msgEl = document.getElementById('lotacao-msg');
                        
                        if (lha < 2) {
                            statusEl.textContent = 'SUBUTILIZADO';
                            statusEl.style.color = '#1976d2';
                            msgEl.textContent = 'Pastagem com capacidade para mais';
                        } else if (lha > 4) {
                            statusEl.textContent = 'SOBRECARGA';
                            statusEl.style.color = '#d32f2f';
                            msgEl.textContent = 'Aten√ß√£o: lota√ß√£o acima do limite!';
                        } else {
                            statusEl.textContent = '√ìTIMO';
                            statusEl.style.color = '#388e3c';
                            msgEl.textContent = 'Lota√ß√£o adequada';
                        }
                    }
                })
                .catch(e => {
                    console.log('Erro ao carregar lota√ß√£o:', e);
                });
        }
        
        // Injetar cards de lota√ß√£o no dashboard
        function injetarLotacaoUI() {
            const statsGrid = document.querySelector('.stats-grid');
            if (!statsGrid || document.getElementById('lotacao-peso')) return;
            
            const lotacaoHTML = document.createElement('div');
            lotacaoHTML.style.cssText = 'grid-column: span 4; display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-top: 15px;';
            lotacaoHTML.innerHTML = `
                <div style="text-align: center; padding: 15px; background: #e3f2fd; border-radius: 10px;">
                    <h5 style="color: #1976d2; margin-bottom: 8px;">Peso Total</h5>
                    <strong id="lotacao-peso" style="font-size: 1.6rem; color: #1976d2;">0</strong>
                    <p style="color: #666; font-size: 0.8rem;">kg</p>
                </div>
                <div style="text-align: center; padding: 15px; background: #e8f5e9; border-radius: 10px;">
                    <h5 style="color: #388e3c; margin-bottom: 8px;">UA Total</h5>
                    <strong id="lotacao-ua" style="font-size: 1.6rem; color: #388e3c;">0</strong>
                    <p style="color: #666; font-size: 0.8rem;">1 UA = 450 kg</p>
                </div>
                <div style="text-align: center; padding: 15px; background: #fff3e0; border-radius: 10px;">
                    <h5 style="color: #f57c00; margin-bottom: 8px;">L/ha</h5>
                    <strong id="lotacao-lha" style="font-size: 1.6rem; color: #f57c00;">0</strong>
                    <p style="color: #666; font-size: 0.8rem;">UA/hectare</p>
                </div>
                <div style="text-align: center; padding: 15px; background: #fce4ec; border-radius: 10px;">
                    <h5 style="color: #c2185b; margin-bottom: 8px;">Status</h5>
                    <strong id="lotacao-status" style="font-size: 1.1rem; color: #c2185b;">-</strong>
                    <p style="color: #666; font-size: 0.75rem;" id="lotacao-msg">carregando...</p>
                </div>
            `;
            statsGrid.parentNode.insertBefore(lotacaoHTML, statsGrid.nextSibling);
            
            // Label de refer√™ncia
            const ref = document.createElement('p');
            ref.style.cssText = 'color: #666; font-size: 0.8rem; margin-top: 12px; margin-bottom: 20px;';
            ref.innerHTML = 'üí° <strong>Refer√™ncia:</strong> 2-4 UA/ha = ideal | Abaixo de 2 = subutilizado | Acima de 4 = sobrecarga';
            lotacaoHTML.parentNode.insertBefore(ref, lotacaoHTML.nextSibling);
        }
        
        // Init
        window.onload = function() {
            initMap();
            loadAll();
            injetarLotacaoUI();
            carregarLotacao();
            carregarAlertas();
        };
        
        // ============ ALERTAS ============
        function carregarAlertas() {
            fetch('/api/alertas/contar')
                .then(r => r.json())
                .then(data => {
                    const badge = document.getElementById('alerta-badge');
                    if (badge) {
                        if (data.total > 0) {
                            badge.textContent = data.total;
                            badge.style.display = 'inline-block';
                        } else {
                            badge.style.display = 'none';
                        }
                    }
                });
        }
        
        // Auto-refresh de alertas a cada 30 segundos
        setInterval(carregarAlertas, 30000);
        
        function exibirAlertas() {
            fetch('/api/alertas')
                .then(r => r.json())
                .then(alertas => {
                    const container = document.getElementById('alertas-container');
                    if (!container) return;
                    
                    if (alertas.length === 0) {
                        container.innerHTML = '<p style="color: #666; text-align: center; padding: 30px;">Nenhum alerta! üéâ</p>';
                        return;
                    }
                    
                    container.innerHTML = alertas.map(a => `
                        <div style="padding: 15px; border-bottom: 1px solid #eee; ${a.lido ? 'opacity: 0.5;' : 'background: #fff3cd;'}" onclick="marcarAlertaLido(${a.id})">
                            <div style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                                <span style="font-size: 1.5rem;">${getEmojiAlerta(a.tipo)}</span>
                                <div style="flex: 1;">
                                    <strong style="color: #1a1a2e; font-size: 0.95rem;">${a.titulo}</strong>
                                    <p style="color: #666; font-size: 0.85rem; margin: 5px 0;">${a.mensagem}</p>
                                    <small style="color: #999; font-size: 0.75rem;">${formatarData(a.created_at)}</small>
                                </div>
                                ${!a.lido ? '<span style="color: #dc3545; font-size: 0.8rem;">‚óè</span>' : ''}
                            </div>
                        </div>
                    `).join('');
                });
        }
        
        function getEmojiAlerta(tipo) {
            switch(tipo) {
                case 'ocupacao_max': return '‚ö†Ô∏è';
                case 'pronto_entrada': return 'üåø';
                case 'pronto_saida': return 'üîî';
                default: return 'üì¢';
            }
        }
        
        function formatarData(dataStr) {
            if (!dataStr) return '';
            const d = new Date(dataStr);
            return d.toLocaleDateString('pt-BR') + ' ' + d.toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'});
        }
        
        function marcarAlertaLido(id) {
            fetch('/api/alertas/' + id + '/ler', {method: 'POST'})
                .then(r => r.json())
                .then(data => {
                    if (data.status === 'ok') {
                        carregarAlertas();
                        exibirAlertas();
                    }
                });
        }
        
        function abrirModalAlertas() {
            document.getElementById('modal-alertas').classList.add('active');
            exibirAlertas();
        }
        
        function fecharModalAlertas() {
            document.getElementById('modal-alertas').classList.remove('active');
        }
        
        function verificarAlertasManualmente() {
            fetch('/api/alertas/verificar', {method: 'POST'})
                .then(r => r.json())
                .then(data => {
                    alert('Verificacao concluida! ' + (data.alertas_criados && data.alertas_criados.length > 0 ? data.alertas_criados.length + ' alertas criados' : 'Nenhum alerta novo'));
                    carregarAlertas();
                    exibirAlertas();
                });
        }
        
        // Carregar data de teste
        function carregarDataTeste() {
            fetch('/api/data-teste')
                .then(r => r.json())
                .then(data => {
                    const display = document.getElementById('data-teste-display');
                    const valor = document.getElementById('data-teste-valor');
                    if (display && valor) {
                        valor.textContent = data.data_formatada;
                        if (data.modo === 'teste') {
                            display.classList.remove('modo-real');
                        } else {
                            display.classList.add('modo-real');
                        }
                    }
                })
                .catch(() => {
                    const valor = document.getElementById('data-teste-valor');
                    if (valor) valor.textContent = 'Erro';
                });
        }
        
        // Carregar data ao iniciar
        carregarDataTeste();
    </script>
    
    <!-- Modal de Alertas -->
    <div class="modal" id="modal-alertas">
        <div class="modal-content" style="width: 450px; max-width: 95%;">
            <div class="modal-header">
                <h3>üîî Alertas de Piquetes</h3>
                <button class="modal-close" onclick="fecharModalAlertas()">√ó</button>
            </div>
            <div id="alertas-container" style="max-height: 400px; overflow-y: auto;"></div>
            <div style="margin-top: 15px; text-align: center;">
                <button class="btn btn-primary" onclick="fecharModalAlertas()">Fechar</button>
            </div>
        </div>
    </div>
</body>
</html>
