<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}{% endblock %} - PastoFlow</title>
    <link rel="icon" type="image/x-icon" href="/static/icon/PastoFlow-logo.ico">
    
    <!-- CSS Globais (sem Bootstrap para evitar conflito com Leaflet) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/fazenda.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/piquetes.css') }}">
    {% if request.path.startswith('/admin') %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">
    {% endif %}
    
    {% block head %}{% endblock %}
    <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
    
    <!-- Service Worker (PWA) -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then((reg) => console.log('SW registrado com sucesso:', reg.scope))
                    .catch((err) => console.log('Erro ao registrar SW:', err));
            });
        }

        // Monitorar Status da Conexão
        function updateOnlineStatus() {
            const offlineAlert = document.getElementById('sidebar-offline-alert');
            if (!offlineAlert) return;
            
            // Tenta fazer um fetch no próprio servidor (ignora o cache do Service Worker)
            // Se o servidor estiver OFF, o fetch vai falhar mesmo com WiFi ligado
            fetch('/api/data-teste?check_server=' + Date.now(), { 
                method: 'HEAD', 
                cache: 'no-store' 
            })
            .then((resp) => {
                // Se respondeu qualquer coisa do servidor, oculta o alerta
                offlineAlert.style.display = 'none';
            })
            .catch(() => {
                // Se falhou o fetch (servidor desligado ou sem internet)
                offlineAlert.style.display = 'block';
                if (navigator.onLine) {
                    offlineAlert.innerHTML = '<i class="fa-solid fa-server"></i> SERVIDOR FORA DO AR';
                    offlineAlert.style.background = '#fd7e14'; // Laranja para servidor off
                } else {
                    offlineAlert.innerHTML = '<i class="fa-solid fa-wifi-slash"></i> ATENÇÃO!<br>VOCÊ ESTÁ OFFLINE';
                    offlineAlert.style.background = '#dc3545'; // Vermelho para internet off
                }
            });
        }

        window.addEventListener('online',  updateOnlineStatus);
        window.addEventListener('offline', updateOnlineStatus);
        // Verificar periodicamente (a cada 30s para ser menos intrusivo)
        setInterval(updateOnlineStatus, 30000);
        // Primeira verificação ao carregar
        document.addEventListener('DOMContentLoaded', updateOnlineStatus);
    </script>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-toggle" onclick="toggleSidebar()" title="Recolher/Expandir">
            <i class="fa-solid fa-chevron-left" id="toggle-icon"></i>
        </div>
        <div class="sidebar-header">
            <img src="/static/icon/PastoFlow-logo.png" alt="PastoFlow" style="width: 120px; margin-bottom: 10px;">
            <span>{{ fazenda.nome if fazenda else 'PastoFlow' }}</span>
            
            <!-- Aviso de Offline -->
            <div id="sidebar-offline-alert" style="display: none; background: #dc3545; color: white; padding: 10px; border-radius: 8px; margin: 10px 0; font-size: 0.85rem; text-align: center; font-weight: bold; animation: pulse 2s infinite;">
                <i class="fa-solid fa-wifi-slash"></i> ATENÇÃO!<br>VOCÊ ESTÁ OFFLINE
            </div>
            <style>
                @keyframes pulse {
                    0% { opacity: 1; }
                    50% { opacity: 0.6; }
                    100% { opacity: 1; }
                }
            </style>

            <div id="data-teste-display" class="data-teste modo-real">
                <div class="data-teste-label">Data do Sistema</div>
                <div class="data-teste-valor" id="data-teste-valor">Carregando...</div>
            </div>
            {% if fazenda %}
            <div id="clima-sidebar" class="data-teste modo-real" style="margin-top:8px;">
                <div class="data-teste-label">Clima Atual (Sistema)</div>
                <div class="data-teste-valor" id="clima-sidebar-valor">Carregando...</div>
            </div>
            {% endif %}
        </div>
        <ul class="menu">
            {% if fazenda %}
            <li class="menu-item {% if request.endpoint == 'fazenda' %}active{% endif %}" onclick="showSection('dashboard')">
                <i class="fa-solid fa-gauge-high"></i> <span>Dashboard</span>
            </li>
            <li class="menu-item" onclick="showSection('piquetes')">
                <i class="fa-solid fa-map-location-dot"></i> <span>Piquetes</span>
            </li>
            <li class="menu-item {% if request.endpoint == 'lotes' %}active{% endif %}" onclick="window.location.href='/fazenda/{{ fazenda.id }}/lotes'">
                <i class="fa-solid fa-clipboard-list"></i> <span>Lotes</span>
            </li>
            <li class="menu-item {% if request.endpoint == 'rotacao' %}active{% endif %}" onclick="window.location.href='/fazenda/{{ fazenda.id }}/rotacao'">
                <i class="fa-solid fa-brain"></i> <span>IA Rotação</span>
            </li>
            <li class="menu-item" onclick="showSection('relatorios')">
                <i class="fa-solid fa-chart-line"></i> <span>Relatórios</span>
            </li>
            <li class="menu-item" onclick="window.location.reload()" title="Recarregar página">
                <i class="fa-solid fa-arrows-rotate"></i> <span>Recarregar</span>
            </li>
            {% else %}
            <li class="menu-item active" onclick="window.location.href='/'">
                <i class="fa-solid fa-house"></i> <span>Home</span>
            </li>
            <li class="menu-item" onclick="window.location.reload()" title="Recarregar página">
                <i class="fa-solid fa-arrows-rotate"></i> <span>Recarregar</span>
            </li>
            {% endif %}
        </ul>
    </div>
    
    <!-- Main -->
    <div class="main">
        <div class="header">
            <h2>{% block header_title %}{% endblock %}</h2>
            <div class="user-info">
                {% if fazenda %}
                <button class="btn" style="background: #6c757d; color: white; padding: 8px 15px; margin-right: 10px;" onclick="verificarAlertasManualmente()" title="Verificar alertas">
                    <i class="fa-solid fa-rotate-right"></i>
                </button>
                <button class="btn" style="background: transparent; color: #1a1a2e; padding: 8px 15px; position: relative;" onclick="abrirModalAlertas()" title="Alertas">
                    <i class="fa-solid fa-bell"></i>
                    <span id="alerta-badge" style="display: none; position: absolute; top: 0; right: 0; background: #dc3545; color: white; border-radius: 50%; padding: 2px 6px; font-size: 0.7rem;">0</span>
                </button>
                {% endif %}
                <a href="{{ url_for('home') }}" style="margin-left: 15px;"><i class="fa-solid fa-house"></i> Início</a>
                <a href="{{ url_for('logout') }}" class="btn btn-danger" style="margin-left: 10px;">Sair</a>
            </div>
        </div>
        
        <div class="content">
            {% block content %}{% endblock %}
        </div>
    </div>

    <!-- Modais Globais -->
    {% if fazenda %}
        {% include 'modals/alertas.html' %}
    {% endif %}

    <!-- Scripts Globais (sem Bootstrap) -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Configuração injetada pelo Flask
        const fazendaId = {{ fazenda.id if fazenda else 'null' }};
        const fazendaNome = "{{ fazenda.nome if fazenda else '' }}";
        const mapaLat = {{ (fazenda.latitude_sede if fazenda.latitude_sede else '-15.7942') if fazenda else '-15.7942' }};
        const mapaLng = {{ (fazenda.longitude_sede if fazenda.longitude_sede else '-47.8822') if fazenda else '-47.8822' }};
        const temSede = {{ ('true' if fazenda.latitude_sede and fazenda.longitude_sede else 'false') if fazenda else 'false' }};

        // Evita "Carregando..." preso em telas sem fazenda (ex.: admin)
        document.addEventListener('DOMContentLoaded', () => {
            const climaSidebar = document.getElementById('clima-sidebar-valor');
            if (!climaSidebar) return;
            if (!fazendaId) {
                climaSidebar.textContent = 'N/A (sem fazenda selecionada)';
            }
        });
    </script>
    <script src="{{ url_for('static', filename='js/fazenda.js') }}"></script>
    {% if fazenda %}
    <script src="{{ url_for('static', filename='js/piquetes.js') }}"></script>
    {% endif %}
    
    {% block scripts %}{% endblock %}
</body>
</html>